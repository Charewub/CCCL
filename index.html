<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabin Crew LOSA Checklist (Firebase)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#DC2626"/>
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
        }
        .required-asterisk::after { content: " *"; color: #ef4444; }
        .checkbox-container { display: flex; flex-wrap: wrap; gap: 4px 6px; font-size: 0.75rem; }
        .sop-dropdown, .narrative-textarea { height: 38px; font-size: 0.75rem; border-radius: 6px; } 
        
        /* TEM Background Colors */
        .bg-t { background-color: #d1fae5; } 
        .bg-e { background-color: #fef9c3; } 
        .bg-u { background-color: #fee2e2; } 
        .bg-c { background-color: #dbeafe; } 
        
        /* Row Highlighting based on SOP Met */
        .sop-fail-row { background-color: #fee2e2 !important; border: 1px solid #f87171; }
        .sop-pass-row { background-color: #d1fae5 !important; border: 1px solid #6ee7b7; }

        #network-status-banner {
            padding: 8px;
            text-align: center;
            font-weight: bold;
            color: white;
            transition: background-color 0.3s ease;
        }
        .status-online { background-color: #16a34a; }
        .status-offline { background-color: #71717a; }

        .checklist-card {
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .checklist-item-group {
            background-color: #e5e7eb; 
            font-weight: bold; 
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 8px;
            margin-top: 24px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl" id="capture-content">
        <div id="network-status-banner" class="rounded-t-xl -mt-6 -mx-6 sm:-mt-10 sm:-mx-10 mb-6"></div>
        <div class="p-6 sm:p-10 pt-0 sm:pt-0">
            <h1 class="text-3xl font-extrabold text-red-600 mb-6 text-center">Cabin Crew LOSA Checklist</h1>
            <form id="checklistForm">

                <section class="mb-8 p-6 bg-red-50 border-l-4 border-red-500 rounded-lg shadow-inner">
                    <h2 class="text-xl font-bold text-red-800 mb-4">I. Flight & Audit Details</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-sm">
                        <div>
                            <label for="observationDate" class="block text-gray-700 font-bold mb-1 required-asterisk">Date of Observation:</label>
                            <input type="date" id="observationDate" name="observationDate" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="flightNumberNew" class="block text-gray-700 font-bold mb-1 required-asterisk">Flight Number:</label>
                            <input type="text" id="flightNumberNew" name="flightNumberNew" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., FD3001" required>
                        </div>
                        <div>
                            <label for="routeFrom" class="block text-gray-700 font-bold mb-1">Route (From):</label>
                            <input type="text" id="routeFrom" name="routeFrom" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., BKK">
                        </div>
                        <div>
                            <label for="routeTo" class="block text-gray-700 font-bold mb-1">Route (To):</label>
                            <input type="text" id="routeTo" name="routeTo" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., CNX">
                        </div>
                        <div>
                            <label for="aircraftType" class="block text-gray-700 font-bold mb-1">Aircraft Type:</label>
                            <input type="text" id="aircraftType" name="aircraftType" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., A320">
                        </div>
                        <div>
                            <label for="observerId" class="block text-gray-700 font-bold mb-1">Observer ID:</label>
                            <input type="text" id="observerId" name="observerId" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., LOSA001">
                        </div>
                        <div>
                            <label for="crewObserved" class="block text-gray-700 font-bold mb-1">No. of Cabin Crew Observed:</label>
                            <input type="number" id="crewObserved" name="crewObserved" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 4">
                        </div>
                        <div>
                            <label for="loadFactor" class="block text-gray-700 font-bold mb-1">Load Factor (%):</label>
                            <input type="text" id="loadFactor" name="loadFactor" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 85%">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="inspectorName" class="block text-gray-700 font-bold mb-1 required-asterisk">Inspector Name:</label>
                            <select id="inspectorName" name="inspectorName" class="w-full px-3 py-2 border rounded-lg bg-white" required>
                                <option value="">-- Select Inspector --</option>
                                <option value="Naparin Boonchuaylue">Naparin Boonchuaylue</option>
                                <option value="Khathawut Benjachinsuwan">Khathawut Benjachinsuwan</option>
                                <option value="Parichat Srithongkul">Parichat Srithongkul</option>
                                <option value="Twankorn Chen">Twankorn Chen</option>
                                <option value="Phinlaphat Aphinyaupatham">Phinlaphat Aphinyaupatham</option>
                                <option value="Alisara Usavagovitwong">Alisara Usavagovitwong</option>
                                <option value="Janpen Vorawanitcha">Janpen Vorawanitcha</option>
                                <option value="Adisorn Usmanbaha">Adisorn Usmanbaha</option>
                                <option value="Chotika Totrakool">Chotika Totrakool</option>
                                <option value="Kittitat Chanta-amornlertkul">Kittitat Chanta-amornlertkul</option>
                                <option value="Busabong Promkhuntod">Busabong Promkhuntod</option>
                            </select>
                        </div>
                    </div>
                </section>
                
                <h2 class="text-lg font-bold text-gray-800 mb-4">III. Observational Checklist by Flight Phase</h2>
                <div id="checklist-container">
                    </div>
                
                <hr class="my-6 border-red-200">
                
                <section class="mb-8 p-6 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-inner">
                    <h2 class="text-lg font-bold text-yellow-800 mb-4">IV. Overall Observations & Summary</h2>
                    <div class="mb-4 text-sm">
                        <label for="sigThreat" class="block text-gray-700 font-bold mb-1">Most significant Threat(s):</label>
                        <textarea id="sigThreat" name="sigThreat" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="mb-4 text-sm">
                        <label for="sigError" class="block text-gray-700 font-bold mb-1">Most significant Error(s):</label>
                        <textarea id="sigError" name="sigError" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="mb-4 text-sm">
                        <label for="effectiveCm" class="block text-gray-700 font-bold mb-1">Most effective Countermeasure(s):</label>
                        <textarea id="effectiveCm" name="effectiveCm" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="mb-4 text-sm">
                        <label for="generalComments" class="block text-gray-700 font-bold mb-1">General comments:</label>
                        <textarea id="generalComments" name="generalComments" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label for="areasOfStrength" class="block text-gray-700 font-bold mb-1">Areas of strength:</label>
                            <textarea id="areasOfStrength" name="areasOfStrength" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                        </div>
                        <div>
                            <label for="opportunitiesForImprovement" class="block text-gray-700 font-bold mb-1">Opportunities for improvement:</label>
                            <textarea id="opportunitiesForImprovement" name="opportunitiesForImprovement" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                        </div>
                    </div>
                    <div class="mb-4 text-sm">
                        <label for="observerSignature" class="block text-gray-700 font-bold mb-1">Observer's Signature:</label>
                        <input type="text" id="observerSignature" name="observerSignature" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="mb-4 text-sm">
                        <label for="reportCompletionDate" class="block text-gray-700 font-bold mb-1">Date of Report Completion:</label>
                        <input type="date" id="reportCompletionDate" name="reportCompletionDate" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </section>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                    <button type="button" id="exportPdfButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 shadow-xl">
                        üìÑ Export to PDF
                    </button>
                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 shadow-xl">
                        üöÄ Submit Report
                    </button>
                </div>
                
            </form>
            
            <div id="pending-firebase-sync" class="mt-8 p-4 bg-blue-100 border border-blue-400 rounded-lg hidden">
                <p class="font-bold text-blue-700">üîÑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ Sync:</p>
                <ul id="pending-list" class="list-disc pl-5 mt-2 text-sm text-blue-600"></ul>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // =================================================================
        // == 1. PASTE YOUR FIREBASE CONFIG HERE ==
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCLVscz3gGmZThIHJRnGtfkZPV865tAOV8", // <<< REPLACE WITH YOUR API KEY
            authDomain: "losafortaatmc.firebaseapp.com",
            projectId: "losafortaatmc",
            storageBucket: "losafortaatmc.firebasestorage.app",
            messagingSenderId: "1037184939611",
            appId: "1:1037184939611:web:ce6571f53cb3f544e0717e",
        };
        // =================================================================

        // Initialize Firebase and Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.enablePersistence().catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("Firestore persistence failed, probably due to multiple open tabs.");
            } else if (err.code == 'unimplemented') {
                console.warn("Firestore persistence is not supported in this browser.");
            }
        });

        // TEM Definitions (unchanged)
        const TEM_CODES = {
            THREATS: { T_TE: "TE: Environmental", T_TO: "TO: Operational", T_TC: "TC: Cabin/Passenger", T_TT: "TT: Team/Crew", T_TL: "TL: Latent" },
            ERRORS: { E_EP: "EP: Procedural", E_EC: "EC: Communication", E_ED: "ED: Decision", E_ES: "ES: Skill-based", E_EV: "EV: Violation (Intentional)" },
            UCS: { U_SOP: "UCS-SOP: Deviation from SOP", U_EQP: "UCS-EQP: Incorrect Equipment use", U_PAX: "UCS-PAX: Compromised PAX safety", U_COM: "UCS-COM: Degraded Communication" },
            CM: { C_PLN: "CM-PLN: Planning", C_SOP: "CM-SOP: Procedural", C_COM: "CM-COM: Communication", C_MON: "CM-MON: Monitoring", C_WSM: "CM-WSM: Workload/Systems Management", C_SPT: "CM-SPT: Support/Teamwork" }
        };
        const TEM_OPTIONS_MAP = { 
            'T': TEM_CODES.THREATS, 
            'E': TEM_CODES.ERRORS, 
            'U': TEM_CODES.UCS, 
            'C': TEM_CODES.CM 
        };
        const CHECKLIST_DEFINITIONS = [
            { id: 'A', title: 'A. Pre-Flight & Crew Briefing', items: [ { id: 'A1', label: '1. Crew Briefing (All Crew - Flight & Cabin)', isGroup: true, subItems: [ { id: 'A11', label: '- Attendance/ Punctuality/ Grooming' }, { id: 'A12', label: '- Documentation (Flight document)' }, { id: 'A13', label: '- Review updated safety information' }, { id: 'A14', label: '- Safety/First aid/Security/DG Review' }, { id: 'A15', label: '- Service Review (if applicable)' }, { id: 'A16', label: '- TEM discussion (anticipated threats)' }, { id: 'A17', label: '- Crew Co-ordination & Communication established' } ]}, { id: 'A2', label: '2. Cabin Crew Briefing (Cabin Specific)', isGroup: true, subItems: [ { id: 'A21', label: '- Allocation of CC station' }, { id: 'A22', label: '- A/C type and equipment fitted' }, { id: 'A23', label: '- Emergency Procedures Review' }, { id: 'A24', label: '- Security Procedures Review (e.g., checked, search, risk level)' }, { id: 'A25', label: '- Special Categoried Passenger Info (e.g., PRMs, YPTA)' } ]}, { id: 'A3', label: '3. Pre-Flight Cabin Checks', isGroup: true, subItems: [ { id: 'A31', label: '- Doors (pre-flight check, serviceablility)' }, { id: 'A32', label: '- Emergency Equipment (location, serviceability)' }, { id: 'A33', label: '- Security Checks (cabin, lavatories, galleys, attendant station)' }, { id: 'A34', label: '- Cabin Cleanliness & Appearance' }, { id: 'A35', label: '- Catering/Supplies (if applicable)' }, { id: 'A36', label: '- Interphone/PA System Check' } ]} ]},
            { id: 'B', title: 'B. Boarding', items: [ { id: 'B1', label: '1. Passenger Greeting & Assistance', isGroup: true, subItems: [ { id: 'B11', label: '- Monitoring carry-on baggage (size, quantity)' }, { id: 'B12', label: '- Refuelling procedure' }, { id: 'B13', label: '- Exit row briefing & compliance' }, { id: 'B14', label: '- Assistance and briefing to special categoried passengers (e.g., PRMs)' }, { id: 'B15', label: '- Managing passenger flow' } ]}, { id: 'B2', label: '2. Pre-Departure Cabin Secure', isGroup: true, subItems: [ { id: 'B21', label: '- Overhead bins closed' }, { id: 'B22', label: '- Galley equipment secured' }, { id: 'B23', label: '- Doors/Aisles/Exits clear' }, { id: 'B24', label: '- Passenger count reconciliation' }, { id: 'B25', label: '- Doors armed / Cross-check procedure' }, { id: 'B26', label: '- Welcome Announcement' } ]}, { id: 'B3', label: '3. Safety Demonstration', isGroup: true, subItems: [ { id: 'B31', label: '- Clarity, accuracy, visibility' }, { id: 'B32', label: '- Passenger attentiveness (managed if needed)' } ]} ]},
            { id: 'C', title: 'C. Taxi-Out, Take-off & Climb', items: [ { id: 'C1', label: '1. Final Cabin Checks', isGroup: true, subItems: [ { id: 'C11', label: '- Take off preparation' }, { id: 'C12', label: '- Report cabin readiness' }, { id: 'C13', label: '- Cabin lighting' }, { id: 'C14', label: '- Performing Brace position' } ]}, { id: 'C2', label: '2. Response to Take-off/Climb', isGroup: true, subItems: [ { id: 'C21', label: '- Sterile Flight Deck Adherence' }, { id: 'C22', label: '- Monitoring cabin condition' }, { id: 'C23', label: '- Awareness of adhoc situation' } ]} ]},
            { id: 'D', title: 'D. Cruise', items: [ { id: 'D1', label: '1. Service Delivery (if applicable)', isGroup: true, subItems: [ { id: 'D11', label: '- Efficiency, safety during service' }, { id: 'D12', label: '- Galley management' } ]}, { id: 'D2', label: '2. Cabin Surveillance', isGroup: true, subItems: [ { id: 'D21', label: '- Periodically check cabin' }, { id: 'D22', label: '- Periodically check on flght crew' }, { id: 'D23', label: '- Periodically check Lavatory' }, { id: 'D24', label: '- Response to call light and Reset' } ]}, { id: 'D3', label: '3. Passenger Handling (if any)', isGroup: true, subItems: [ { id: 'D31', label: '- Medical situations' }, { id: 'D32', label: '- Unruly/disruptive passengers' }, { id: 'D33', label: '- Others' } ]}, { id: 'D4', label: '4. Communication with Flight Crew (if any)', isGroup: true, subItems: [ { id: 'D41', label: '- Reporting irregularities (If any)' } ]}, { id: 'D5', label: '5. Turbulence Management', isGroup: true, subItems: [ { id: 'D51', label: '- Follow turbulance management procedure' }, { id: 'D52', label: '- Secure self' } ]} ]},
            { id: 'E', title: 'E. Descent, Approach & Landing', items: [ { id: 'E1', label: '1. Pre-Landing Announcements & Cabin Prep', isGroup: true, subItems: [ { id: 'E11', label: '- Pre-landing preparation' } ]}, { id: 'E2', label: '2. Final Cabin Checks (Landing)', isGroup: true, subItems: [ { id: 'E21', label: '- Seatbelts, tray tables, seatbacks, PEDs, etc.' }, { id: 'E22', label: '- Report cabin readiness' }, { id: 'E23', label: '- Cabin lighting' }, { id: 'E24', label: '- Performing Brace position' } ]}, { id: 'E3', label: '3. Sterile Flight Deck Adherence' }, { id: 'E4', label: '4. Response to Landing', isGroup: true, subItems: [ { id: 'E41', label: '- Monitoring cabin condition' } ]} ]},
            { id: 'F', title: 'F. Taxi-In & Disembarkation', items: [ { id: 'F1', label: '1. Arrival Duties', isGroup: true, subItems: [ { id: 'F11', label: '- Arrival Announcement' }, { id: 'F12', label: '- Cabin monitoring' }, { id: 'F13', label: '- Doors Disarmed / Cross-check procedure' }, { id: 'F14', label: '- Doors Opening Procedure' } ]}, { id: 'F2', label: '2. Disembarkation Process', isGroup: true, subItems: [ { id: 'F21', label: '- Cabin monitoring' }, { id: 'F22', label: '- Assistance to special categoried passenger' }, { id: 'F23', label: '- Refueling procedure (If any)' }, { id: 'F24', label: '- Cabin check after passenger disembarkation and Report' } ]}, { id: 'F3', label: '3. Post-Flight Cabin Checks', isGroup: true, subItems: [ { id: 'F31', label: '- Perform Security Checks' }, { id: 'F32', label: '- Perform transit duties' }, { id: 'F33', label: '- Reporting cabin defects (If any)' } ]} ]},
            { id: 'G', title: 'G. Post-Flight / Debrief (Observed if possible)', items: [ { id: 'G1', label: '1. Crew Debrief', isGroup: true, subItems: [ { id: 'G11', label: '- Discussion of flight events' }, { id: 'G12', label: '- Sharing idea' }, { id: 'G13', label: '- Feedback on TEM' } ]}, { id: 'G2', label: '2. Reporting System', isGroup: true, subItems: [ { id: 'G21', label: '- Redeye' } ]} ]}
        ];
        
        // Helper functions (unchanged)

        function createCheckboxGroup(baseName, typeCode, options) {
            let html = `<div class="checkbox-container">`;
            for (const code in options) {
                if (options.hasOwnProperty(code)) {
                    const fieldName = `${baseName}_${typeCode}`;
                    const inputValue = options[code];
                    const shortCode = code.split('_')[1] || code;
                    html += `<label title="${options[code]}" class="inline-flex items-center space-x-1 cursor-pointer"><input type="checkbox" name="${fieldName}" value="${inputValue}" class="form-checkbox text-red-600 rounded"><span>${shortCode}</span></label>`;
                }
            }
            return html + `</div>`;
        }
        
        function createDropdown(name, isSOP = false) {
            const select = document.createElement('select');
            select.name = name;
            select.className = `w-full border rounded-lg bg-white sop-dropdown`;
            if (isSOP) { select.innerHTML = `<option value="" selected>--</option><option value="Y">Y</option><option value="N">N</option><option value="NA">NA</option>`; }
            return select.outerHTML;
        }
        
        function createTextArea(name, placeholder) {
            return `<textarea name="${name}" rows="1" class="w-full border rounded-lg narrative-textarea" placeholder="${placeholder}"></textarea>`;
        }
        
        function generateChecklistHTML() {
            const checklistContainer = document.getElementById('checklist-container');
            let html = '';
            CHECKLIST_DEFINITIONS.forEach(section => {
                html += `<div class="mb-8"><h3 class="text-md font-bold text-white bg-red-600 p-2 rounded-t-lg">${section.title}</h3><div class="p-2 border border-t-0 rounded-b-lg">`;
                section.items.forEach(item => {
                    if (item.isGroup && item.subItems) {
                        html += `<div class="checklist-item-group">${item.label}</div>`;
                    }
                    const itemsToRender = item.isGroup && item.subItems ? item.subItems : [item];
                    itemsToRender.forEach(subItem => {
                        const baseName = `${subItem.id}`;
                        html += `<div class="checklist-card rounded-lg p-3 md:p-4 mb-3" id="card-${baseName}">
                                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                                            <p class="font-semibold text-gray-800 flex-grow">${subItem.label}</p>
                                            <div class="flex items-center gap-2 flex-shrink-0 w-full sm:w-auto">
                                                <label for="${baseName}_SOP" class="font-bold text-sm text-gray-600">SOP Met:</label>
                                                ${createDropdown(`${baseName}_SOP`, true)}
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4 text-xs">
                                            <div class="bg-t p-2 rounded-md"><h4 class="font-bold text-sm text-green-800 mb-1">Threats</h4>${createCheckboxGroup(baseName, 'T', TEM_OPTIONS_MAP.T)}</div>
                                            <div class="bg-e p-2 rounded-md"><h4 class="font-bold text-sm text-yellow-800 mb-1">Errors</h4>${createCheckboxGroup(baseName, 'E', TEM_OPTIONS_MAP.E)}</div>
                                            <div class="bg-u p-2 rounded-md"><h4 class="font-bold text-sm text-red-800 mb-1">UCS</h4>${createCheckboxGroup(baseName, 'U', TEM_OPTIONS_MAP.U)}</div>
                                            <div class="bg-c p-2 rounded-md"><h4 class="font-bold text-sm text-blue-800 mb-1">CM</h4>${createCheckboxGroup(baseName, 'C', TEM_OPTIONS_MAP.C)}</div>
                                        </div>
                                        <div>
                                            <label for="${baseName}_Narrative" class="font-bold text-sm text-gray-600">Narrative/Comments:</label>
                                            ${createTextArea(`${baseName}_Narrative`, 'Describe here...')}
                                        </div>
                                    </div>`;
                    });
                });
                html += `</div></div>`;
            });
            checklistContainer.innerHTML = html;
        }
        
        function addSopChangeEventHandlers() {
            document.getElementById('checklist-container').addEventListener('change', (event) => {
                if (event.target && event.target.matches('select[name$="_SOP"]')) {
                    const baseId = event.target.name.replace('_SOP', '');
                    const card = document.getElementById(`card-${baseId}`);
                    if (card) {
                        card.classList.remove('sop-fail-row', 'sop-pass-row');
                        if (event.target.value === 'Y') {
                            card.classList.add('sop-pass-row');
                        } else if (event.target.value === 'N') {
                            card.classList.add('sop-fail-row');
                        }
                    }
                }
            });
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('observationDate').value = today;
            document.getElementById('reportCompletionDate').value = today;
        }

        // --- UPDATED: Export to PDF Function with CSS Handling for ALL input types ---
        async function exportToPDF() {
            const { jsPDF } = window.jspdf; 
            const element = document.getElementById('capture-content');
            const flightNumber = document.getElementById('flightNumberNew').value || 'LOSA_Report';
            const date = document.getElementById('observationDate').value || new Date().toISOString().split('T')[0];

            Swal.fire({
                title: 'Generating PDF...',
                text: 'Preparing layout and processing pages. Please wait.',
                didOpen: () => {
                    Swal.showLoading();
                },
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            // 1. Add Temporary Print/Export CSS to fix input wrapping/clipping issues
            const tempStyle = document.createElement('style');
            tempStyle.id = 'export-fix-style';
            tempStyle.textContent = `
                /* Target ALL input types, textareas, and selects */
                #capture-content input, 
                #capture-content textarea, 
                #capture-content select {
                    height: auto !important;
                    min-height: 38px; /* Maintain minimum height for consistency */
                    white-space: normal; 
                    overflow: visible !important;
                    padding-top: 5px; 
                    padding-bottom: 5px;
                    /* Ensure date/number inputs also expand if necessary */
                    box-sizing: border-box !important;
                }
                /* Hide buttons, status, and pending areas in the screenshot/PDF */
                #network-status-banner, #capture-content button, #pending-firebase-sync {
                    display: none !important;
                }
            `;
            document.head.appendChild(tempStyle);

            try {
                // 2. Convert the entire element to a single canvas image
                const canvas = await html2canvas(element, {
                    scale: 2, 
                    allowTaint: true,
                    useCORS: true,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight
                });
                
                // 3. Initialize jsPDF and handle multi-page conversion
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                
                // A4 dimensions in mm (210 x 297)
                const pdf = new jsPDF('p', 'mm', 'a4'); 
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = pdfWidth / imgWidth;
                const height = imgHeight * ratio;

                let position = 0; 
                let remainingHeight = height;

                while (remainingHeight > 0) {
                    if (position > 0) {
                        pdf.addPage();
                    }
                    
                    // Add image portion: position is negative to simulate cropping from the top of the full image
                    pdf.addImage(imgData, 'JPEG', 0, -position, pdfWidth, height);

                    remainingHeight -= pdfHeight;
                    position += pdfHeight; 
                }

                // 4. Save the PDF
                const filename = `${date}_${flightNumber}_LOSA.pdf`;
                pdf.save(filename);

                Swal.close();
                Swal.fire({
                    icon: 'success',
                    title: 'PDF Export Complete!',
                    text: `Saved report as ${filename}`,
                    timer: 3000,
                    showConfirmButton: false
                });

            } catch(error) {
                Swal.close();
                console.error('PDF Export Error:', error);
                Swal.fire('Export Failed', 'Could not generate PDF. Please check console for details.', 'error');
            } finally {
                // 5. Remove the temporary CSS style immediately after use
                const cleanupStyle = document.getElementById('export-fix-style');
                if (cleanupStyle) {
                    cleanupStyle.remove();
                }
            }
        }
        // --- End Export to PDF Function ---


        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('checklistForm');
            const exportButton = document.getElementById('exportPdfButton');

            generateChecklistHTML();
            addSopChangeEventHandlers();
            setTodayDate();

            exportButton.addEventListener('click', exportToPDF);
            
            // Network Status Logic (unchanged)
            const statusBanner = document.getElementById('network-status-banner');
            function updateNetworkStatus() {
                if (navigator.onLine) {
                    statusBanner.textContent = 'üü¢ Online - All data will be synced automatically.';
                    statusBanner.className = 'status-online rounded-t-xl -mt-6 -mx-6 sm:-mt-10 sm:-mx-10 mb-6';
                } else {
                    statusBanner.textContent = '‚ö™ Offline - Your work is saved locally.';
                    statusBanner.className = 'status-offline rounded-t-xl -mt-6 -mx-6 sm:-mt-10 sm:-mx-10 mb-6';
                }
            }
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();

            let pendingWrites = {};
            const pendingContainer = document.getElementById('pending-firebase-sync');
            const pendingList = document.getElementById('pending-list');

            function updatePendingUI() {
                if (Object.keys(pendingWrites).length > 0) {
                    pendingContainer.classList.remove('hidden');
                    pendingList.innerHTML = '';
                    for (const id in pendingWrites) {
                        const item = pendingWrites[id];
                        const li = document.createElement('li');
                        li.textContent = `Flight ${item.flightNumber || 'N/A'} - Status: ${item.status}`;
                        pendingList.appendChild(li);
                    }
                } else {
                    pendingContainer.classList.add('hidden');
                }
            }
            
            function getAllFormKeys() {
                const keys = new Set([
                    'observationDate', 'flightNumberNew', 'routeFrom', 'routeTo', 
                    'aircraftType', 'observerId', 'crewObserved', 'loadFactor', 'inspectorName',
                    'sigThreat', 'sigError', 'effectiveCm', 'generalComments', 
                    'areasOfStrength', 'opportunitiesForImprovement', 'observerSignature', 'reportCompletionDate'
                ]);

                CHECKLIST_DEFINITIONS.forEach(section => {
                    section.items.forEach(item => {
                        const itemsToProcess = item.isGroup && item.subItems ? item.subItems : [item];
                        itemsToProcess.forEach(subItem => {
                            const baseName = subItem.id;
                            keys.add(`${baseName}_SOP`);
                            keys.add(`${baseName}_Narrative`);
                            Object.keys(TEM_OPTIONS_MAP).forEach(typeCode => {
                                keys.add(`${baseName}_${typeCode}`);
                            });
                        });
                    });
                });

                return Array.from(keys);
            }


            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');

                const requiredFields = ['observationDate', 'flightNumberNew', 'inspectorName'];
                for (const id of requiredFields) {
                    const field = document.getElementById(id);
                    if (!field.value) {
                        Swal.fire('Incomplete Data', `Please fill out: ${field.labels[0].textContent.replace(' *', '')}`, 'error');
                        field.focus();
                        return;
                    }
                }

                Swal.fire({
                    title: 'Confirm Submission',
                    text: "Are you sure you want to submit this report?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#DC2626',
                    cancelButtonColor: '#6B7280',
                    confirmButtonText: 'Yes, submit it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitButton.disabled = true;

                        const reportData = {};
                        const allFormKeys = getAllFormKeys();
                        const formData = new FormData(form);
                        const submittedCheckboxes = {};
                        
                        allFormKeys.forEach(key => {
                            reportData[key] = "";
                        });

                        for (const [key, value] of formData.entries()) {
                            const trimmedValue = value.trim();
                            const element = form.elements[key];
                            
                            if (element && element.type === 'checkbox') {
                                if (!submittedCheckboxes[key]) submittedCheckboxes[key] = [];
                                submittedCheckboxes[key].push(trimmedValue);
                            } 
                            else if (trimmedValue !== "") {
                                if (element && element.type === 'number') {
                                     reportData[key] = parseFloat(trimmedValue);
                                } else {
                                     reportData[key] = trimmedValue;
                                }
                            }
                        }
                        
                        for (const key in submittedCheckboxes) {
                            if (submittedCheckboxes[key].length > 0) {
                                reportData[key] = submittedCheckboxes[key].join(' | ');
                            }
                        }

                        reportData.submissionTimestamp = firebase.firestore.FieldValue.serverTimestamp();

                        const newReportRef = db.collection("reports").doc();
                        const docId = newReportRef.id;

                        pendingWrites[docId] = {
                            flightNumber: reportData.flightNumberNew,
                            status: navigator.onLine ? 'Syncing...' : 'Queued, waiting for connection...'
                        };
                        updatePendingUI();
                        
                        const unsubscribe = newReportRef.onSnapshot({ includeMetadataChanges: true }, (doc) => {
                            if (doc.metadata.hasPendingWrites === false && pendingWrites[docId]) {
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'success',
                                    title: `Flight ${pendingWrites[docId].flightNumber} has been synced!`,
                                    showConfirmButton: false,
                                    timer: 3000
                                });
                                delete pendingWrites[docId];
                                updatePendingUI();
                                unsubscribe();
                            }
                        });

                        newReportRef.set(reportData)
                        .then(() => {
                            Swal.fire('Saved!', 'Report has been saved. It will sync automatically when online.', 'info');
                            
                            form.reset();
                            setTodayDate();
                            document.querySelectorAll('.sop-fail-row, .sop-pass-row').forEach(card => {
                                card.classList.remove('sop-fail-row', 'sop-pass-row');
                            });
                        })
                        .catch((error) => {
                            Swal.fire('Local Save Error!', `Could not save the report. Please check console. Error: ${error.message}`, 'error');
                            delete pendingWrites[docId];
                            updatePendingUI();
                        })
                        .finally(() => {
                            submitButton.disabled = false;
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>
