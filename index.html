<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabin Crew LOSA Checklist (Offline Ready)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#DC2626"/>
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .required-asterisk::after { content: " *"; color: #ef4444; }
        .checklist-container { overflow-x: auto; }
        .checklist-table { min-width: 900px; }
        .checklist-table th, .checklist-table td { padding: 4px; border: 1px solid #e5e7eb; vertical-align: middle; }
        .checklist-table th { background-color: #f3f4f6; text-align: left; font-size: 0.7rem; color: #374151; font-weight: 600; }
        .checklist-item-group td { background-color: #f0f0f0; font-weight: bold; font-size: 0.8rem; padding: 6px 4px; }
        .checkbox-container { display: flex; flex-wrap: wrap; gap: 4px 6px; font-size: 0.75rem; }
        .sop-dropdown, .narrative-textarea { height: 38px; font-size: 0.75rem; border-radius: 6px; }
        .bg-t { background-color: #e6ffec; } .bg-e { background-color: #fff9e6; } .bg-u { background-color: #ffe6e6; } .bg-c { background-color: #e6f0ff; }
        .checklist-table td { font-size: 0.75rem; }
        .sop-fail-row { background-color: #fee2e2 !important; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-red-600 mb-6 text-center">Cabin Crew LOSA Checklist</h1>
        <form id="checklistForm">

            <section class="mb-8 p-6 bg-red-50 border-l-4 border-red-500 rounded-lg shadow-inner">
                <h2 class="text-xl font-bold text-red-800 mb-4">I. Flight & Audit Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-sm">
                    <div>
                        <label for="observationDate" class="block text-gray-700 font-bold mb-1 required-asterisk">Date of Observation:</label>
                        <input type="date" id="observationDate" name="observationDate" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label for="flightNumberNew" class="block text-gray-700 font-bold mb-1 required-asterisk">Flight Number:</label>
                        <input type="text" id="flightNumberNew" name="flightNumberNew" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., FD3001" required>
                    </div>
                    <div>
                        <label for="routeFrom" class="block text-gray-700 font-bold mb-1">Route (From):</label>
                        <input type="text" id="routeFrom" name="routeFrom" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., BKK">
                    </div>
                    <div>
                        <label for="routeTo" class="block text-gray-700 font-bold mb-1">Route (To):</label>
                        <input type="text" id="routeTo" name="routeTo" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., CNX">
                    </div>
                    <div>
                        <label for="aircraftType" class="block text-gray-700 font-bold mb-1">Aircraft Type:</label>
                        <input type="text" id="aircraftType" name="aircraftType" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., A320">
                    </div>
                    <div>
                        <label for="observerId" class="block text-gray-700 font-bold mb-1">Observer ID:</label>
                        <input type="text" id="observerId" name="observerId" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., LOSA001">
                    </div>
                    <div>
                        <label for="crewObserved" class="block text-gray-700 font-bold mb-1">No. of Cabin Crew Observed:</label>
                        <input type="number" id="crewObserved" name="crewObserved" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 4">
                    </div>
                    <div>
                        <label for="loadFactor" class="block text-gray-700 font-bold mb-1">Load Factor (%):</label>
                        <input type="text" id="loadFactor" name="loadFactor" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 85%">
                    </div>
                </div>
                <div class="mb-4 text-sm">
                    <label for="inspectorName" class="block text-gray-700 font-bold mb-1 required-asterisk">Inspector Name:</label>
                    <select id="inspectorName" name="inspectorName" class="w-full px-3 py-2 border rounded-lg bg-white" required>
                        <option value="">-- Select Inspector --</option>
                        <option value="Naparin Boonchuaylue">Naparin Boonchuaylue</option>
                        <option value="Khathawut Benjachinsuwan">Khathawut Benjachinsuwan</option>
                        <option value="Parichat Srithongkul">Parichat Srithongkul</option>
                        <option value="Twankorn Chen">Twankorn Chen</option>
                        <option value="Phinlaphat Aphinyaupatham">Phinlaphat Aphinyaupatham</option>
                        <option value="Alisara Usavagovitwong">Alisara Usavagovitwong</option>
                        <option value="Janpen Vorawanitcha">Janpen Vorawanitcha</option>
                        <option value="Adisorn Usmanbaha">Adisorn Usmanbaha</option>
                        <option value="Chotika Totrakool">Chotika Totrakool</option>
                        <option value="Kittitat Chanta-amornlertkul">Kittitat Chanta-amornlertkul</option>
                        <option value="Busabong Promkhuntod">Busabong Promkhuntod</option>
                    </select>
                </div>
            </section>
            
            <h2 class="text-lg font-bold text-gray-800 mb-4">III. Observational Checklist</h2>
            <div id="checklist-container" class="checklist-container"></div>
            
            <hr class="my-6">
            
            <section class="mb-8 p-6 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-inner">
                <h2 class="text-lg font-bold text-yellow-800 mb-4">IV. Overall Observations & Summary</h2>
                <div class="mb-4 text-sm">
                    <label for="sigThreat" class="block text-gray-700 font-bold mb-1">Most significant Threat(s):</label>
                    <textarea id="sigThreat" name="sigThreat" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div class="mb-4 text-sm">
                    <label for="sigError" class="block text-gray-700 font-bold mb-1">Most significant Error(s):</label>
                    <textarea id="sigError" name="sigError" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div class="mb-4 text-sm">
                    <label for="effectiveCm" class="block text-gray-700 font-bold mb-1">Most effective Countermeasure(s):</label>
                    <textarea id="effectiveCm" name="effectiveCm" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div class="mb-4 text-sm">
                    <label for="generalComments" class="block text-gray-700 font-bold mb-1">General comments:</label>
                    <textarea id="generalComments" name="generalComments" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    <div>
                        <label for="areasOfStrength" class="block text-gray-700 font-bold mb-1">Areas of strength:</label>
                        <textarea id="areasOfStrength" name="areasOfStrength" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div>
                        <label for="opportunitiesForImprovement" class="block text-gray-700 font-bold mb-1">Opportunities for improvement:</label>
                        <textarea id="opportunitiesForImprovement" name="opportunitiesForImprovement" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                </div>
                <div class="mb-4 text-sm">
                    <label for="observerSignature" class="block text-gray-700 font-bold mb-1">Observer's Signature:</label>
                    <input type="text" id="observerSignature" name="observerSignature" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="mb-4 text-sm">
                    <label for="reportCompletionDate" class="block text-gray-700 font-bold mb-1">Date of Report Completion:</label>
                    <input type="date" id="reportCompletionDate" name="reportCompletionDate" class="w-full px-3 py-2 border rounded-lg">
                </div>
            </section>
            
            <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 mt-6 shadow-xl">
                üíæ Submit Report
            </button>
            <div id="statusMessage" class="text-center mt-3 text-sm font-semibold"></div>

            <div id="pendingSync" class="mt-8 p-4 bg-red-100 border border-red-400 rounded-lg hidden">
                <p class="font-bold text-red-700">‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå:</p>
                <ul id="pendingList" class="list-disc pl-5 mt-2 text-sm text-red-600"></ul>
                <button type="button" id="manualSyncBtn" class="mt-3 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                </button>
            </div>

        </form>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyuv84dwQd0L8Fx_OBY0tB0Ht6hDfPeqCpc9DrpF17FL-A3taiUBuS9ENBSfQNCwJN83Q/exec'; 
        const EMAIL_DESTINATION = "Guntrakonj@airasia.com";
        const FORM_KEY = 'checklistSubmissionsJSON_v2';
        
        // --- DATA DEFINITIONS ---
        const TEM_CODES = {
            THREATS: { T_TE: "TE: Environmental", T_TO: "TO: Operational", T_TC: "TC: Cabin/Passenger", T_TT: "TT: Team/Crew", T_TL: "TL: Latent" },
            ERRORS: { E_EP: "EP: Procedural", E_EC: "EC: Communication", E_ED: "ED: Decision", E_ES: "ES: Skill-based", E_EV: "EV: Violation (Intentional)" },
            UCS: { U_SOP: "UCS-SOP: Deviation from SOP", U_EQP: "UCS-EQP: Incorrect Equipment use", U_PAX: "UCS-PAX: Compromised PAX safety", U_COM: "UCS-COM: Degraded Communication" },
            CM: { C_PLN: "CM-PLN: Planning", C_SOP: "CM-SOP: Procedural", C_COM: "CM-COM: Communication", C_MON: "CM-MON: Monitoring", C_WSM: "CM-WSM: Workload/Systems Management", C_SPT: "CM-SPT: Support/Teamwork" }
        };
        const CHECKLIST_DEFINITIONS = [
            { id: 'A', title: 'A. Pre-Flight & Crew Briefing', items: [ { id: 'A1', label: '1. Crew Briefing', isGroup: true, subItems: [ { id: 'A11', label: '- Attendance/ Punctuality/ Grooming' }, { id: 'A12', label: '- Documentation' }, { id: 'A13', label: '- Review updated safety info' }, { id: 'A14', label: '- Safety/First aid/Security/DG Review' }, { id: 'A15', label: '- Service Review' }, { id: 'A16', label: '- TEM discussion' }, { id: 'A17', label: '- Crew Co-ordination' } ]}, { id: 'A2', label: '2. Cabin Crew Briefing', isGroup: true, subItems: [ { id: 'A21', label: '- Allocation of CC station' }, { id: 'A22', label: '- A/C type and equipment' }, { id: 'A23', label: '- Emergency Procedures Review' }, { id: 'A24', label: '- Security Procedures Review' }, { id: 'A25', label: '- Special Passenger Info' } ]}, { id: 'A3', label: '3. Pre-Flight Cabin Checks', isGroup: true, subItems: [ { id: 'A31', label: '- Doors (pre-flight check)' }, { id: 'A32', label: '- Emergency Equipment' }, { id: 'A33', label: '- Security Checks' }, { id: 'A34', label: '- Cabin Cleanliness' }, { id: 'A35', label: '- Catering/Supplies' }, { id: 'A36', label: '- Interphone/PA System Check' } ]} ]},
            { id: 'B', title: 'B. Boarding', items: [ { id: 'B1', label: '1. Passenger Greeting & Assistance', isGroup: true, subItems: [ { id: 'B11', label: '- Monitoring carry-on baggage' }, { id: 'B12', label: '- Refuelling procedure' }, { id: 'B13', label: '- Exit row briefing' }, { id: 'B14', label: '- Special passenger assistance' }, { id: 'B15', label: '- Managing passenger flow' } ]}, { id: 'B2', label: '2. Pre-Departure Cabin Secure', isGroup: true, subItems: [ { id: 'B21', label: '- Overhead bins closed' }, { id: 'B22', label: '- Galley secured' }, { id: 'B23', label: '- Exits clear' }, { id: 'B24', label: '- Passenger count' }, { id: 'B25', label: '- Doors armed / Cross-check' }, { id: 'B26', label: '- Welcome Announcement' } ]}, { id: 'B3', label: '3. Safety Demonstration', isGroup: true, subItems: [ { id: 'B31', label: '- Clarity, accuracy' }, { id: 'B32', label: '- Passenger attentiveness' } ]} ]},
            { id: 'C', title: 'C. Taxi-Out, Take-off & Climb', items: [ { id: 'C1', label: '1. Final Cabin Checks', isGroup: true, subItems: [ { id: 'C11', label: '- Take off preparation' }, { id: 'C12', label: '- Report cabin readiness' }, { id: 'C13', label: '- Cabin lighting' }, { id: 'C14', label: '- Brace position' } ]}, { id: 'C2', label: '2. Response to Take-off/Climb', isGroup: true, subItems: [ { id: 'C21', label: '- Sterile Flight Deck Adherence' }, { id: 'C22', label: '- Monitoring cabin condition' }, { id: 'C23', label: '- Awareness of adhoc situation' } ]} ]},
            { id: 'D', title: 'D. Cruise', items: [ { id: 'D1', label: '1. Service Delivery', isGroup: true, subItems: [ { id: 'D11', label: '- Efficiency, safety' }, { id: 'D12', label: '- Galley management' } ]}, { id: 'D2', label: '2. Cabin Surveillance', isGroup: true, subItems: [ { id: 'D21', label: '- Periodically check cabin' }, { id: 'D22', label: '- Periodically check on flight crew' }, { id: 'D23', label: '- Periodically check Lavatory' }, { id: 'D24', label: '- Response to call light' } ]}, { id: 'D3', label: '3. Passenger Handling', isGroup: true, subItems: [ { id: 'D31', label: '- Medical situations' }, { id: 'D32', label: '- Unruly passengers' }, { id: 'D33', label: '- Others' } ]}, { id: 'D4', label: '4. Communication with Flight Crew', isGroup: true, subItems: [ { id: 'D41', label: '- Reporting irregularities' } ]}, { id: 'D5', label: '5. Turbulence Management', isGroup: true, subItems: [ { id: 'D51', label: '- Follow procedure' }, { id: 'D52', label: '- Secure self' } ]} ]},
            { id: 'E', title: 'E. Descent, Approach & Landing', items: [ { id: 'E1', label: '1. Pre-Landing Announcements', isGroup: true, subItems: [ { id: 'E11', label: '- Pre-landing preparation' } ]}, { id: 'E2', label: '2. Final Cabin Checks (Landing)', isGroup: true, subItems: [ { id: 'E21', label: '- Seatbelts, tables, etc.' }, { id: 'E22', label: '- Report cabin readiness' }, { id: 'E23', label: '- Cabin lighting' }, { id: 'E24', label: '- Brace position' } ]}, { id: 'E3', label: '3. Sterile Flight Deck Adherence' }, { id: 'E4', label: '4. Response to Landing', isGroup: true, subItems: [ { id: 'E41', label: '- Monitoring cabin' } ]} ]},
            { id: 'F', title: 'F. Taxi-In & Disembarkation', items: [ { id: 'F1', label: '1. Arrival Duties', isGroup: true, subItems: [ { id: 'F11', label: '- Arrival Announcement' }, { id: 'F12', label: '- Cabin monitoring' }, { id: 'F13', label: '- Doors Disarmed / Cross-check' }, { id: 'F14', label: '- Doors Opening' } ]}, { id: 'F2', label: '2. Disembarkation', isGroup: true, subItems: [ { id: 'F21', label: '- Cabin monitoring' }, { id: 'F22', label: '- Special passenger assistance' }, { id: 'F23', label: '- Refueling procedure' }, { id: 'F24', label: '- Post-disembarkation check' } ]}, { id: 'F3', label: '3. Post-Flight Checks', isGroup: true, subItems: [ { id: 'F31', label: '- Security Checks' }, { id: 'F32', label: '- Transit duties' }, { id: 'F33', label: '- Reporting defects' } ]} ]},
            { id: 'G', title: 'G. Post-Flight / Debrief', items: [ { id: 'G1', label: '1. Crew Debrief', isGroup: true, subItems: [ { id: 'G11', label: '- Discussion of flight' }, { id: 'G12', label: '- Sharing ideas' }, { id: 'G13', label: '- Feedback on TEM' } ]}, { id: 'G2', label: '2. Reporting System', isGroup: true, subItems: [ { id: 'G21', label: '- Redeye' } ]} ]}
        ];

        // --- UI GENERATION ---
        function generateChecklistHTML() {
            const container = document.getElementById('checklist-container');
            let html = CHECKLIST_DEFINITIONS.map(section => {
                const rows = section.items.map(item => {
                    const groupHeader = item.isGroup ? `<tr class="checklist-item-group"><td colspan="7">${item.label}</td></tr>` : '';
                    const subItems = (item.isGroup ? item.subItems : [item]).map(sub => `
                        <tr class="checklist-item text-xs">
                            <td class="font-normal">${sub.label}</td>
                            <td>${createDropdown(`${sub.id}_SOP`, true)}</td>
                            <td class="bg-t">${createCheckboxGroup(sub.id, 'T', TEM_CODES.THREATS)}</td>
                            <td class="bg-e">${createCheckboxGroup(sub.id, 'E', TEM_CODES.ERRORS)}</td>
                            <td class="bg-u">${createCheckboxGroup(sub.id, 'U', TEM_CODES.UCS)}</td>
                            <td class="bg-c">${createCheckboxGroup(sub.id, 'C', TEM_CODES.CM)}</td>
                            <td>${createTextArea(`${sub.id}_Narrative`, 'Describe here...')}</td>
                        </tr>`).join('');
                    return groupHeader + subItems;
                }).join('');

                return `
                    <div class="mb-8">
                        <h3 class="text-md font-bold text-white bg-red-600 p-2 rounded-t-lg">${section.title}</h3>
                        <div class="overflow-x-auto">
                            <table class="checklist-table w-full">
                                <thead>
                                    <tr>
                                        <th class="w-2/5">Check Item / Area of Observation</th>
                                        <th>SOP Met</th>
                                        <th class="bg-t">Threats</th><th class="bg-e">Errors</th><th class="bg-u">UCS</th><th class="bg-c">CM</th>
                                        <th class="w-1/4">Narrative/Comments</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>`;
            }).join('');
            container.innerHTML = html;
        }
        function createCheckboxGroup(baseId, type, options) {
            return `<div class="checkbox-container">${Object.entries(options).map(([code, title]) => `
                <label title="${title}" class="inline-flex items-center space-x-1 cursor-pointer">
                    <input type="checkbox" name="${baseId}_${type}" value="${title}" class="form-checkbox text-red-600 rounded">
                    <span>${code.split('_')[1]}</span>
                </label>`).join('')}</div>`;
        }
        function createDropdown(name, isSOP) {
            const options = isSOP ? ['Y', 'N', 'NA'].map(v => `<option value="${v}">${v}</option>`).join('') : '';
            return `<select name="${name}" class="w-full border rounded-lg bg-white sop-dropdown"><option value="" selected>--</option>${options}</select>`;
        }
        function createTextArea(name, placeholder) {
            return `<textarea name="${name}" rows="1" class="w-full border rounded-lg narrative-textarea" placeholder="${placeholder}"></textarea>`;
        }

        // --- CORE LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('checklistForm');
            
            const setTodayDate = () => {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('observationDate').value = today;
                document.getElementById('reportCompletionDate').value = today;
            };

            const addSopChangeEventHandlers = () => {
                form.querySelectorAll('select[name$="_SOP"]').forEach(dropdown => {
                    dropdown.addEventListener('change', e => {
                        e.target.closest('tr')?.classList.toggle('sop-fail-row', e.target.value === 'N');
                    });
                });
            };

            const getLocalData = () => JSON.parse(localStorage.getItem(FORM_KEY)) || [];
            const saveLocalData = (data) => {
                localStorage.setItem(FORM_KEY, JSON.stringify(data));
                updatePendingSyncUI();
            };

            const updatePendingSyncUI = () => {
                const submissions = getLocalData();
                const pendingDiv = document.getElementById('pendingSync');
                const list = document.getElementById('pendingList');
                list.innerHTML = '';
                pendingDiv.classList.toggle('hidden', submissions.length === 0);
                if (submissions.length > 0) {
                    submissions.forEach((data, index) => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center py-1';
                        li.innerHTML = `<span>Item ${index + 1}: Flt ${data.flightNumberNew || 'N/A'}</span>`;
                        const btn = document.createElement('button');
                        btn.textContent = 'Delete';
                        btn.type = 'button';
                        btn.className = 'ml-4 px-2 py-1 text-xs font-bold text-white bg-red-500 rounded hover:bg-red-700';
                        btn.onclick = () => deleteSpecificData(index);
                        li.appendChild(btn);
                        list.appendChild(li);
                    });
                }
            };
            
            const deleteSpecificData = (index) => {
                Swal.fire({
                    title: 'Confirm Deletion', text: `Delete pending item ${index + 1}?`, icon: 'warning',
                    showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete it!'
                }).then(result => {
                    if (result.isConfirmed) {
                        const data = getLocalData();
                        data.splice(index, 1);
                        saveLocalData(data);
                        Swal.fire('Deleted!', 'The item has been removed.', 'success');
                    }
                });
            };

            const sendDataToServer = async (data) => {
                document.getElementById('statusMessage').textContent = 'Sending...';
                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data, email: EMAIL_DESTINATION })
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'Success') {
                            document.getElementById('statusMessage').textContent = `‚úÖ Success!`;
                            return true;
                        } else {
                            throw new Error(result.message || 'Server returned an error.');
                        }
                    } else {
                        throw new Error(`HTTP Error: ${response.status}`);
                    }
                } catch (error) {
                    document.getElementById('statusMessage').textContent = `‚ö†Ô∏è Network/Server Error. Saved locally.`;
                    console.error("sendDataToServer Error:", error);
                    return false;
                }
            };

            const resyncData = async () => {
                const submissions = getLocalData();
                if (submissions.length === 0) return Swal.fire('All Good!', 'No pending data.', 'success');
                Swal.fire({ title: 'Syncing...', html: 'Sending pending data...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                let remaining = [...submissions];
                for (const data of submissions) {
                    if (await sendDataToServer(data)) {
                        remaining.shift();
                    } else {
                        Swal.update({ icon: 'error', title: 'Sync Failed', html: 'Sync stopped. Please check connection.' });
                        break;
                    }
                }
                saveLocalData(remaining);
                if (remaining.length === 0) {
                    Swal.fire('Sync Complete', 'All pending data has been sent.', 'success');
                }
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const data = {};
                const checkboxGroups = {};

                for(const [key, value] of formData.entries()) {
                    if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
                        if (!checkboxGroups[key]) checkboxGroups[key] = [];
                        checkboxGroups[key].push(value);
                    } else {
                        data[key] = value;
                    }
                }
                for(const key in checkboxGroups) data[key] = checkboxGroups[key].join(' | ');

                data['Observation_Timestamp'] = new Date().toISOString();

                if (await sendDataToServer(data)) {
                    Swal.fire('Success!', 'Report submitted to the server!', 'success');
                    form.reset();
                    setTodayDate();
                } else {
                    const localData = getLocalData();
                    localData.push(data);
                    saveLocalData(localData);
                    Swal.fire('Saved Locally', 'Could not connect. Data saved for later sync.', 'warning');
                }
            });

            document.getElementById('manualSyncBtn').addEventListener('click', resyncData);
            
            // Initial setup
            generateChecklistHTML();
            addSopChangeEventHandlers();
            setTodayDate();
            updatePendingSyncUI();
        });
    </script>
</body>
</html>

