<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabin Crew LOSA Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#DC2626"/>
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        body { font-family: 'Inter', 'Kanit', sans-serif; }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .online { background-color: #2ecc71; }
        .offline { background-color: #e74c3c; }
        /* สไตล์สำหรับตาราง Checklist */
        .checklist-container { overflow-x: auto; }
        .checklist-table { min-width: 900px; } /* ปรับให้กระชับขึ้น */
        .checklist-table th, .checklist-table td { padding: 4px; border: 1px solid #e5e7eb; vertical-align: middle; }
        .checklist-table th { background-color: #f3f4f6; text-align: left; font-size: 0.7rem; color: #374151; font-weight: 600; }
        .checklist-item { background-color: #ffffff; }
        .checklist-item-group td { background-color: #f0f0f0; font-weight: bold; font-size: 0.8rem; padding: 6px 4px; }

        /* ปรับขนาด Dropdown SOP */
        .sop-dropdown {
             font-size: 0.75rem;
             padding: 4px 6px;
             height: 38px;
             border-radius: 6px;
             border: 1px solid #d1d5db;
             min-width: 65px;
             max-width: 100%;
        }
        .narrative-textarea {
             font-size: 0.7rem;
             padding: 3px;
             min-height: 38px;
             resize: vertical;
             line-height: 1.2;
        }
        
        /* สไตล์สำหรับ Checkbox Container (TEM Codes) */
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 6px; /* ปรับระยะห่าง */
            font-size: 0.75rem;
            line-height: 1;
            padding: 4px 2px;
        }
        .checkbox-container label {
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
        }
        .checkbox-container input[type="checkbox"] {
            transform: scale(1.3); /* ทำให้ Checkbox ใหญ่ขึ้น กดง่ายขึ้น */
            margin-right: 4px;
        }


        /* กำหนดความกว้างคอลัมน์ใหม่ให้กระชับ */
        .item-col { width: 25%; font-size: 0.75rem; }
        .sop-col { width: 9%; }
        .code-col { width: 10%; } /* 4 x 10% = 40% */
        .narrative-col { width: 26%; }

        .bg-t { background-color: #e6ffec; }
        .bg-e { background-color: #fff9e6; }
        .bg-u { background-color: #ffe6e6; }
        .bg-c { background-color: #e6f0ff; }

        /* ลบดาวแดง */
        .required-asterisk::after {
            content: none !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto max-w-4xl p-2 sm:p-4">
        <header class="bg-red-600 text-white p-4 rounded-lg shadow-md mb-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold">Cabin Crew LOSA Checklist</h1>
                <p class="text-xs sm:text-sm opacity-90">Line Operations Safety Audit (LOSA)</p>
            </div>
            <div class="flex items-center space-x-2 text-right">
                <span id="status-text" class="font-semibold text-sm">Offline</span>
                <span id="status-dot" class="status-dot offline"></span>
            </div>
        </header>
        <form id="checklist-form" class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">I. Flight & Audit Details</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-sm">
                <div>
                    <label for="observation-date" class="block text-gray-700 font-bold mb-1 required-asterisk">Date of Observation:</label>
                    <input type="date" id="observation-date" name="observation-date" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="flight-number-new" class="block text-gray-700 font-bold mb-1 required-asterisk">Flight Number:</label>
                    <input type="text" id="flight-number-new" name="flight-number-new" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., FD3001" required>
                </div>
                <div>
                    <label for="route-from" class="block text-gray-700 font-bold mb-1 required-asterisk">Route (From):</label>
                    <input type="text" id="route-from" name="route-from" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., BKK" required>
                </div>
                <div>
                    <label for="route-to" class="block text-gray-700 font-bold mb-1 required-asterisk">Route (To):</label>
                    <input type="text" id="route-to" name="route-to" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., CNX" required>
                </div>
                <div>
                    <label for="aircraft-type" class="block text-gray-700 font-bold mb-1 required-asterisk">Aircraft Type:</label>
                    <input type="text" id="aircraft-type" name="aircraft-type" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., A320" required>
                </div>
                <div>
                    <label for="observer-id" class="block text-gray-700 font-bold mb-1">Observer ID (if applicable):</label>
                    <input type="text" id="observer-id" name="observer-id" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., LOSA001">
                </div>
                <div>
                    <label for="crew-observed" class="block text-gray-700 font-bold mb-1 required-asterisk">No. of Cabin Crew Observed:</label>
                    <input type="number" id="crew-observed" name="crew-observed" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 4" required>
                </div>
                <div>
                    <label for="load-factor" class="block text-gray-700 font-bold mb-1">Load Factor (Approx. % full):</label>
                    <input type="text" id="load-factor" name="load-factor" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 85%">
                </div>
            </div>
            <div class="mb-4 text-sm">
                <label for="inspector-name" class="block text-gray-700 font-bold mb-1 required-asterisk">Inspector Name:</label>
                <select id="inspector-name" name="inspector-name" class="w-full px-3 py-2 border rounded-lg bg-white" required>
                    <option value="" disabled selected>-- Select Name --</option>
                    <option value="Naparin Boonchuaylue">Naparin Boonchuaylue</option>
                    <option value="Khathawut Benjachinsuwan">Khathawut Benjachinsuwan</option>
                    <option value="Parichat Srithongkul">Parichat Srithongkul</option>
                    <option value="Twankorn Chen">Twankorn Chen</option>
                    <option value="Phinlaphat Aphinyaupatham">Phinlaphat Aphinyaupatham</option>
                    <option value="Alisara Usavagovitwong">Alisara Usavagovitwong</option>
                    <option value="Janpen Vorawanitcha">Janpen Vorawanitcha</option>
                    <option value="Adisorn Usmanbaha">Adisorn Usmanbaha</option>
                    <option value="Chotika Totrakool">Chotika Totrakool</option>
                    <option value="Kittitat Chanta-amornlertkul">Kittitat Chanta-amornlertkul</option>
                    <option value="Busabong Promkhuntod">Busabong Promkhuntod</option>
                </select>
            </div>
            <input type="hidden" id="flight-number" name="flight-number" value="">
            <hr class="my-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">III. Observational Checklist by Flight Phase</h2>
            <p class="text-sm text-gray-600 mb-4">For each phase, note compliance with SOPs, observed TEM elements, and provide a brief narrative.</p>
            <div id="checklist-container" class="checklist-container">
                </div>
            <hr class="my-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">IV. Overall Observations & Summary</h2>
            <div class="mb-4 text-sm">
                <label for="sig-threat" class="block text-gray-700 font-bold mb-1">Most significant Threat(s) observed during the flight:</label>
                <textarea id="sig-threat" name="sig-threat" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            <div class="mb-4 text-sm">
                <label for="sig-error" class="block text-gray-700 font-bold mb-1">Most significant Error(s) observed (or potential errors successfully managed):</label>
                <textarea id="sig-error" name="sig-error" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            <div class="mb-4 text-sm">
                <label for="effective-cm" class="block text-gray-700 font-bold mb-1">Most effective Countermeasure(s) observed:</label>
                <textarea id="effective-cm" name="effective-cm" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            <div class="mb-4 text-sm">
                <label for="general-comments" class="block text-gray-700 font-bold mb-1">General comments on crew performance, teamwork, and adherence to SOPs:</label>
                <textarea id="general-comments" name="general-comments" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                <div>
                    <label for="areas-of-strength" class="block text-gray-700 font-bold mb-1">Areas of strength:</label>
                    <textarea id="areas-of-strength" name="areas-of-strength" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label for="opportunities-for-improvement" class="block text-gray-700 font-bold mb-1">Opportunities for improvement (e.g., training, procedures, equipment):</label>
                    <textarea id="opportunities-for-improvement" name="opportunities-for-improvement" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
            </div>
            <div class="mb-4 text-sm">
                <label for="observer-signature" class="block text-gray-700 font-bold mb-1">Observer's Signature (If applicable):</label>
                <input type="text" id="observer-signature" name="observer-signature" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="mb-4 text-sm">
                <label for="report-completion-date" class="block text-gray-700 font-bold mb-1 required-asterisk">Date of Report Completion:</label>
                <input type="date" id="report-completion-date" name="report-completion-date" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <p class="text-xs text-gray-500 italic">The purpose of this tool is to contribute to the continuous improvement of our cabin safety performance and the effectiveness of our training programs. Your diligence in ensuring its proper adaptation and approved use is crucial for maintaining Thai AirAsia's commitment to the highest safety standards.</p>
            <hr class="my-6">
            <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 mt-6">
                Save Checklist
            </button>
        </form>
                <div class="mt-6">
            <div class="flex justify-between items-center mb-2">
                 <h2 class="text-lg sm:text-xl font-bold text-gray-800">Pending Sync (<span id="pending-count">0</span>)</h2>
                 <button id="manual-sync-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm hidden">
                     Sync Now
                 </button>
            </div>
            <div id="pending-list" class="bg-white p-4 rounded-lg shadow-md max-h-48 overflow-y-auto">
                <p class="text-gray-500 text-center">No pending items.</p>
            </div>
        </div>
    </div>
    <script>
        // *** ⚠️ CONFIGURATION: ACTION URL AND MAPPING ⚠️ ***
        const GOOGLE_FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSc4zKoIsAGEmMbTCxoDEwY65vXcarZ88RmXv_v17gLcVGMtaw/formResponse";

        // MAPPED INPUT ID (ใช้ ID ที่คุณได้ให้มา)
        const INPUT_MAPPING = {
            // I. Flight & Audit Details
            "observationDate": "entry.1360175660",
            "flightNumberNew": "entry.1540799313", // ใช้สำหรับ input ใหม่
            "routeFrom": "entry.1113572581",
            "routeTo": "entry.2138943017",
            "aircraftType": "entry.1748057276",
            "observerId": "entry.91525082",
            "crewObserved": "entry.1901029029",
            "loadFactor": "entry.160222908",
            "inspectorName": "entry.1596435461",
            "flightNumber": "entry.639782702", // Hidden/Copy

            // III. Observational Checklist (A - Pre-Flight)
            // A11. Attendance/ Punctuality/ Grooming
            "A11_SOP": "entry.1785429892",
            "A11_T": "entry.735316771",
            "A11_E": "entry.2069630137",
            "A11_U": "entry.187659374",
            "A11_C": "entry.1653696502",
            "A11_N_T": "entry.1473069569",
            "A11_N_E": "entry.1332625332",
            "A11_N_U": "entry.1969755521",
            "A11_N_C": "entry.1304266301",
            // A12. Documentation (Flight document)
            "A12_SOP": "entry.1984838785",
            "A12_T": "entry.1087827812",
            "A12_E": "entry.943579404",
            "A12_U": "entry.1274172653",
            "A12_C": "entry.842429887",
            "A12_N_T": "entry.1940933296",
            "A12_N_E": "entry.389469558",
            "A12_N_U": "entry.1303895367",
            "A12_N_C": "entry.271399426",
            // A13. Review updated safety information
            "A13_SOP": "entry.637209943",
            "A13_T": "entry.1304806958",
            "A13_E": "entry.131228570",
            "A13_U": "entry.749528620",
            "A13_C": "entry.192450603",
            "A13_N_T": "entry.1030715683",
            "A13_N_E": "entry.817859316",
            "A13_N_U": "entry.860293135",
            "A13_N_C": "entry.2102132004",
            // A14. Safety/First aid/Security/DG Review
            "A14_SOP": "entry.2075129827",
            "A14_T": "entry.1105511483",
            "A14_E": "entry.1077159290",
            "A14_U": "entry.1311298589",
            "A14_C": "entry.1407101283",
            "A14_N_T": "entry.1156460039",
            "A14_N_E": "entry.2031842867",
            "A14_N_U": "entry.1247010463",
            "A14_N_C": "entry.1870782966",
            // A15. Service Review (if applicable)
            "A15_SOP": "entry.2005517370",
            "A15_T": "entry.1883730690",
            "A15_E": "entry.1001345626",
            "A15_U": "entry.1403840155",
            "A15_C": "entry.1847030866",
            "A15_N_T": "entry.863502071",
            "A15_N_E": "entry.919061557",
            "A15_N_U": "entry.15173700",
            "A15_N_C": "entry.629114237",
            // A16. TEM discussion (anticipated threats)
            "A16_SOP": "entry.942434902",
            "A16_T": "entry.8510098",
            "A16_E": "entry.594835023",
            "A16_U": "entry.2063441432",
            "A16_C": "entry.654234353",
            "A16_N_T": "entry.762076255",
            "A16_N_E": "entry.1272298021",
            "A16_N_U": "entry.765963",
            "A16_N_C": "entry.287233058",
            // A17. Crew Co-ordination & Communication established
            "A17_SOP": "entry.1406512596",
            "A17_T": "entry.295834319",
            "A17_E": "entry.545709145",
            "A17_U": "entry.614079307",
            "A17_C": "entry.1724746752",
            "A17_N_T": "entry.1713163724",
            "A17_N_E": "entry.1100239050",
            "A17_N_U": "entry.1682293565",
            "A17_N_C": "entry.183799642",
            // A21. Allocation of CC station
            "A21_SOP": "entry.1465611110",
            "A21_T": "entry.1679255965",
            "A21_E": "entry.263821450",
            "A21_U": "entry.816835744",
            "A21_C": "entry.1818622423",
            "A21_N_T": "entry.32118738",
            "A21_N_E": "entry.1966489368",
            "A21_N_U": "entry.371536278",
            "A21_N_C": "entry.481483745",
            // A22. A/C type and equipment fitted
            "A22_SOP": "entry.2094789424",
            "A22_T": "entry.1329508470",
            "A22_E": "entry.430719621",
            "A22_U": "entry.74444577",
            "A22_C": "entry.228626500",
            "A22_N_T": "entry.664001747",
            "A22_N_E": "entry.535377860",
            "A22_N_U": "entry.2137250184",
            "A22_N_C": "entry.1905619764",
            // A23. Emergency Procedures Review
            "A23_SOP": "entry.1820010630",
            "A23_T": "entry.464695213",
            "A23_E": "entry.1008623914",
            "A23_U": "entry.1345713151",
            "A23_C": "entry.401238072",
            "A23_N_T": "entry.274402414",
            "A23_N_E": "entry.456752855",
            "A23_N_U": "entry.662109840",
            "A23_N_C": "entry.1783989703",
            // A24. Security Procedures Review
            "A24_SOP": "entry.707235179",
            "A24_T": "entry.1053217027",
            "A24_E": "entry.1021752281",
            "A24_U": "entry.400435928",
            "A24_C": "entry.678308219",
            "A24_N_T": "entry.226344707",
            "A24_N_E": "entry.867729503",
            "A24_N_U": "entry.1737947864",
            "A24_N_C": "entry.788757847",
            // A25. Special Categoried Passenger Info
            "A25_SOP": "entry.657006333",
            "A25_T": "entry.1939707265",
            "A25_E": "entry.1787117475",
            "A25_U": "entry.314911475",
            "A25_C": "entry.2006518618",
            "A25_N_T": "entry.1248270784",
            "A25_N_E": "entry.1440193046",
            "A25_N_U": "entry.1189060406",
            "A25_N_C": "entry.933795243",
            // A31. Doors (pre-flight check)
            "A31_SOP": "entry.1215909643",
            "A31_T": "entry.1457316756",
            "A31_E": "entry.368528906",
            "A31_U": "entry.552896594",
            "A31_C": "entry.1077906441",
            "A31_N_T": "entry.1111024962",
            "A31_N_E": "entry.1141855947",
            "A31_N_U": "entry.1208777804",
            "A31_N_C": "entry.150636349",
            // A32. Emergency Equipment (serviceability)
            "A32_SOP": "entry.345883997",
            "A32_T": "entry.1539129933",
            "A32_E": "entry.1758199018",
            "A32_U": "entry.1308455368",
            "A32_C": "entry.305383623",
            "A32_N_T": "entry.2033767616",
            "A32_N_E": "entry.784595530",
            "A32_N_U": "entry.172469000",
            "A32_N_C": "entry.1385680547",
            // A33. Security Checks (cabin, lavatories, galleys)
            "A33_SOP": "entry.1935422574",
            "A33_T": "entry.1173341519",
            "A33_E": "entry.58631797",
            "A33_U": "entry.857499837",
            "A33_C": "entry.24403585",
            "A33_N_T": "entry.502461803",
            "A33_N_E": "entry.516135061",
            "A33_N_U": "entry.1908268844",
            "A33_N_C": "entry.1147527757",
            // A34. Cabin Cleanliness & Appearance
            "A34_SOP": "entry.308117859",
            "A34_T": "entry.299138682",
            "A34_E": "entry.870517057",
            "A34_U": "entry.371012331",
            "A34_C": "entry.1420968646",
            "A34_N_T": "entry.354318367",
            "A34_N_E": "entry.1290045041",
            "A34_N_U": "entry.1240026702",
            "A34_N_C": "entry.1298783388",
            // A35. Catering/Supplies
            "A35_SOP": "entry.921797263",
            "A35_T": "entry.1824031474",
            "A35_E": "entry.647940468",
            "A35_U": "entry.62959734",
            "A35_C": "entry.443263381",
            "A35_N_T": "entry.937722891",
            "A35_N_E": "entry.610908320",
            "A35_N_U": "entry.1040254241",
            "A35_N_C": "entry.2144015095",
            // A36. Interphone/PA System Check
            "A36_SOP": "entry.904186478",
            "A36_T": "entry.2069159360",
            "A36_E": "entry.833424152",
            "A36_U": "entry.1459645915",
            "A36_C": "entry.424752652",
            "A36_N_T": "entry.1583861553",
            "A36_N_E": "entry.1276433087",
            "A36_N_U": "entry.1475102241",
            "A36_N_C": "entry.2143049920",

            // III. Observational Checklist (B - Boarding)
            // B11. Monitoring carry-on baggage
            "B11_SOP": "entry.2111635098",
            "B11_T": "entry.773527645",
            "B11_E": "entry.158957014",
            "B11_U": "entry.212827224",
            "B11_C": "entry.1652305651",
            "B11_N_T": "entry.305781461",
            "B11_N_E": "entry.1325919182",
            "B11_N_U": "entry.1794541272",
            "B11_N_C": "entry.774506017",
            // B12. Refuelling procedure (Boarding)
            "B12_SOP": "entry.198567115",
            "B12_T": "entry.770377773",
            "B12_E": "entry.1265391498",
            "B12_U": "entry.80671189",
            "B12_C": "entry.1920385022",
            "B12_N_T": "entry.934750148",
            "B12_N_E": "entry.1534494274",
            "B12_N_U": "entry.1318264185",
            "B12_N_C": "entry.1857788175",
            // B13. Exit row briefing & compliance
            "B13_SOP": "entry.2106569703",
            "B13_T": "entry.1348530099",
            "B13_E": "entry.104399703",
            "B13_U": "entry.1884141243",
            "B13_C": "entry.164054269",
            "B13_N_T": "entry.1645137503",
            "B13_N_E": "entry.1256385476",
            "B13_N_U": "entry.1039478190",
            "B13_N_C": "entry.388016388",
            // B14. Assistance/briefing to special categorized pax
            "B14_SOP": "entry.282352894",
            "B14_T": "entry.2101726123",
            "B14_E": "entry.537534099",
            "B14_U": "entry.584351070",
            "B14_C": "entry.1554161270",
            "B14_N_T": "entry.2146041576",
            "B14_N_E": "entry.1027135183",
            "B14_N_U": "entry.1344032412",
            "B14_N_C": "entry.1843866175",
            // B15. Managing passenger flow
            "B15_SOP": "entry.1080238816",
            "B15_T": "entry.881718059",
            "B15_E": "entry.789058732",
            "B15_U": "entry.738522159",
            "B15_C": "entry.1911283806",
            "B15_N_T": "entry.416365717",
            "B15_N_E": "entry.1179029569",
            "B15_N_U": "entry.1241660189",
            "B15_N_C": "entry.541777055",
            // B21. Overhead bins closed
            "B21_SOP": "entry.478682738",
            "B21_T": "entry.1059022055",
            "B21_E": "entry.1738817295",
            "B21_U": "entry.1628763867",
            "B21_C": "entry.1801415408",
            "B21_N_T": "entry.44969629",
            "B21_N_E": "entry.350765047",
            "B21_N_U": "entry.555075907",
            "B21_N_C": "entry.1352586819",
            // B22. Galley equipment secured
            "B22_SOP": "entry.1005210176",
            "B22_T": "entry.833605690",
            "B22_E": "entry.1103993106",
            "B22_U": "entry.498750675",
            "B22_C": "entry.1036538184",
            "B22_N_T": "entry.725212935",
            "B22_N_E": "entry.1387211214",
            "B22_N_U": "entry.435519969",
            "B22_N_C": "entry.1927818561",
            // B23. Doors/Aisles/Exits clear
            "B23_SOP": "entry.1774417561",
            "B23_T": "entry.505189863",
            "B23_E": "entry.878518525",
            "B23_U": "entry.1117756490",
            "B23_C": "entry.799525861",
            "B23_N_T": "entry.1702027486",
            "B23_N_E": "entry.1792352273",
            "B23_N_U": "entry.1045285844",
            "B23_N_C": "entry.1311278414",
            // B24. Passenger count reconciliation
            "B24_SOP": "entry.803504412",
            "B24_T": "entry.1701977724",
            "B24_E": "entry.1127519308",
            "B24_U": "entry.1777629664",
            "B24_C": "entry.1358871293",
            "B24_N_T": "entry.353937067",
            "B24_N_E": "entry.249987199",
            "B24_N_U": "entry.1357706475",
            "B24_N_C": "entry.2080113210",
            // B25. Doors armed / Cross-check procedure
            "B25_SOP": "entry.600408048",
            "B25_T": "entry.811478927",
            "B25_E": "entry.694978733",
            "B25_U": "entry.538419698",
            "B25_C": "entry.618739161",
            "B25_N_T": "entry.752494006",
            "B25_N_E": "entry.684484963",
            "B25_N_U": "entry.1298228112",
            "B25_N_C": "entry.128659223",
            // B26. Welcome Announcement
            "B26_SOP": "entry.1089593417",
            "B26_T": "entry.1627487379",
            "B26_E": "entry.642166501",
            "B26_U": "entry.436171841",
            "B26_C": "entry.684589372",
            "B26_N_T": "entry.1110707473",
            "B26_N_E": "entry.1755377751",
            "B26_N_U": "entry.724489614",
            "B26_N_C": "entry.321522301",
            // B31. Safety Demonstration (Clarity/Visibility)
            "B31_SOP": "entry.884090387",
            "B31_T": "entry.940848976",
            "B31_E": "entry.1566000520",
            "B31_U": "entry.201748452",
            "B31_C": "entry.258118673",
            "B31_N_T": "entry.251581671",
            "B31_N_E": "entry.1754003621",
            "B31_N_U": "entry.1496748501",
            "B31_N_C": "entry.378849154",
            // B32. Passenger attentiveness (managed if needed)
            "B32_SOP": "entry.2112056262",
            "B32_T": "entry.1191851206",
            "B32_E": "entry.1349339528",
            "B32_U": "entry.1229559054",
            "B32_C": "entry.833619018",
            "B32_N_T": "entry.270045719",
            "B32_N_E": "entry.2038083789",
            "B32_N_U": "entry.430327294",
            "B32_N_C": "entry.1527583573",

            // III. Observational Checklist (C - Taxi-Out, Take-off & Climb)
            // C11. Take off preparation
            "C11_SOP": "entry.1477411498",
            "C11_T": "entry.1600899972",
            "C11_E": "entry.546336706",
            "C11_U": "entry.1500985032",
            "C11_C": "entry.1537022519",
            "C11_N_T": "entry.923645576",
            "C11_N_E": "entry.1875846932",
            "C11_N_U": "entry.123237316",
            "C11_N_C": "entry.732529933",
            // C12. Report cabin readiness
            "C12_SOP": "entry.348609009",
            "C12_T": "entry.10545994",
            "C12_E": "entry.931318773",
            "C12_U": "entry.2120793528",
            "C12_C": "entry.1386872478",
            "C12_N_T": "entry.350428762",
            "C12_N_E": "entry.1638039337",
            "C12_N_U": "entry.575670726",
            "C12_N_C": "entry.400409154",
            // C13. Cabin lighting (Taxi-Out)
            "C13_SOP": "entry.854722135",
            "C13_T": "entry.470418911",
            "C13_E": "entry.167480106",
            "C13_U": "entry.212011997",
            "C13_C": "entry.1797398882",
            "C13_N_T": "entry.528703538",
            "C13_N_E": "entry.821875386",
            "C13_N_U": "entry.387390125",
            "C13_N_C": "entry.504189000",
            // C14. Performing Brace position (Take Off)
            "C14_SOP": "entry.689961473",
            "C14_T": "entry.1333946327",
            "C14_E": "entry.866519425",
            "C14_U": "entry.1319495950",
            "C14_C": "entry.370090746",
            "C14_N_T": "entry.1116135499",
            "C14_N_E": "entry.123876871",
            "C14_N_U": "entry.494101487",
            "C14_N_C": "entry.944476786",
            // C21. Sterile Flight Deck Adherence (Climb)
            "C21_SOP": "entry.1738962195",
            "C21_T": "entry.987908823",
            "C21_E": "entry.682026513",
            "C21_U": "entry.163849888",
            "C21_C": "entry.1154677978",
            "C21_N_T": "entry.2037672826",
            "C21_N_E": "entry.948089782",
            "C21_N_U": "entry.1638616097",
            "C21_N_C": "entry.1591733658",
            // C22. Monitoring cabin condition (Climb)
            "C22_SOP": "entry.212924543",
            "C22_T": "entry.990245169",
            "C22_E": "entry.314488123",
            "C22_U": "entry.190331730",
            "C22_C": "entry.1652002609",
            "C22_N_T": "entry.846453063",
            "C22_N_E": "entry.1844226722",
            "C22_N_U": "entry.1254965151",
            "C22_N_C": "entry.1605501176",
            // C23. Awareness of adhoc situation (Climb)
            "C23_SOP": "entry.2117764236",
            "C23_T": "entry.75421210",
            "C23_E": "entry.2013039840",
            "C23_U": "entry.2112484159",
            "C23_C": "entry.186641914",
            "C23_N_T": "entry.2120980534",
            "C23_N_E": "entry.425672907",
            "C23_N_U": "entry.1504828842",
            "C23_N_C": "entry.198539338",

            // III. Observational Checklist (D - Cruise)
            // D11. Service Delivery (Efficiency, safety)
            "D11_SOP": "entry.931283840",
            "D11_T": "entry.1641374178",
            "D11_E": "entry.176907646",
            "D11_U": "entry.52638756",
            "D11_C": "entry.1594463215",
            "D11_N_T": "entry.1372519258",
            "D11_N_E": "entry.1828372627",
            "D11_N_U": "entry.1535060746",
            "D11_N_C": "entry.2083102289",
            // D12. Galley management (Cruise)
            "D12_SOP": "entry.246841952",
            "D12_T": "entry.524964078",
            "D12_E": "entry.1019208890",
            "D12_U": "entry.553319975",
            "D12_C": "entry.2023669832",
            "D12_N_T": "entry.339369496",
            "D12_N_E": "entry.1235184519",
            "D12_N_U": "entry.1457080344",
            "D12_N_C": "entry.585061276",
            // D21. Periodically check cabin (Cruise)
            "D21_SOP": "entry.943336803",
            "D21_T": "entry.729145532",
            "D21_E": "entry.573553578",
            "D21_U": "entry.1741873871",
            "D21_C": "entry.62760589",
            "D21_N_T": "entry.647858125",
            "D21_N_E": "entry.1720384532",
            "D21_N_U": "entry.1274258682",
            "D21_N_C": "entry.1357597291",
            // D22. Periodically check on flght crew
            "D22_SOP": "entry.295461834",
            "D22_T": "entry.396048314",
            "D22_E": "entry.2056324825",
            "D22_U": "entry.706290128",
            "D22_C": "entry.652681656",
            "D22_N_T": "entry.968111884",
            "D22_N_E": "entry.195404611",
            "D22_N_U": "entry.1057522564",
            "D22_N_C": "entry.780130125",
            // D23. Periodically check Lavatory
            "D23_SOP": "entry.589326472",
            "D23_T": "entry.1647860643",
            "D23_E": "entry.1785709054",
            "D23_U": "entry.1622674779",
            "D23_C": "entry.690507277",
            "D23_N_T": "entry.65511091",
            "D23_N_E": "entry.208808889",
            "D23_N_U": "entry.298404206",
            "D23_N_C": "entry.1112324100",
            // D24. Response to call light and Reset
            "D24_SOP": "entry.1287213393",
            "D24_T": "entry.822206574",
            "D24_E": "entry.1469221252",
            "D24_U": "entry.1406006929",
            "D24_C": "entry.1362440303",
            "D24_N_T": "entry.362773509",
            "D24_N_E": "entry.988087611",
            "D24_N_U": "entry.1073897790",
            "D24_N_C": "entry.388361713",
            // D31. Medical situations
            "D31_SOP": "entry.123776359",
            "D31_T": "entry.1182237185",
            "D31_E": "entry.1438809082",
            "D31_U": "entry.1243699040",
            "D31_C": "entry.828794842",
            "D31_N_T": "entry.1150973333",
            "D31_N_E": "entry.978722331",
            "D31_N_U": "entry.1222693200",
            "D31_N_C": "entry.1395038645",
            // D32. Unruly/disruptive passengers
            "D32_SOP": "entry.695599515",
            "D32_T": "entry.169184633",
            "D32_E": "entry.1131777789",
            "D32_U": "entry.1192597368",
            "D32_C": "entry.493931155",
            "D32_N_T": "entry.263872488",
            "D32_N_E": "entry.2055461517",
            "D32_N_U": "entry.1321019439",
            "D32_N_C": "entry.1249031868",
            // D33. Others (Pax Handling)
            "D33_SOP": "entry.597293937",
            "D33_T": "entry.1828598822",
            "D33_E": "entry.2040914258",
            "D33_U": "entry.133960290",
            "D33_C": "entry.1401930603",
            "D33_N_T": "entry.1307317542",
            "D33_N_E": "entry.349842102",
            "D33_N_U": "entry.1003291437",
            "D33_N_C": "entry.1280227590",
            // D41. Reporting irregularities (If any)
            "D41_SOP": "entry.314986686",
            "D41_T": "entry.1186480740",
            "D41_E": "entry.836483714",
            "D41_U": "entry.1013639905",
            "D41_C": "entry.1173059774",
            "D41_N_T": "entry.570782594",
            "D41_N_E": "entry.1799079598",
            "D41_N_U": "entry.808225289",
            "D41_N_C": "entry.346637261",
            // D51. Follow turbulance management procedure
            "D51_SOP": "entry.209484011",
            "D51_T": "entry.1288944544",
            "D51_E": "entry.935766539",
            "D51_U": "entry.1156108370",
            "D51_C": "entry.171219287",
            "D51_N_T": "entry.588013611",
            "D51_N_E": "entry.1563692944",
            "D51_N_U": "entry.471403804",
            "D51_N_C": "entry.1856786590",
            // D52. Secure self (Turbulence)
            "D52_SOP": "entry.1371844862",
            "D52_T": "entry.1097770001",
            "D52_E": "entry.1127301180",
            "D52_U": "entry.1165826698",
            "D52_C": "entry.2139747114",
            "D52_N_T": "entry.1300376024",
            "D52_N_E": "entry.1030900781",
            "D52_N_U": "entry.1391015044",
            "D52_N_C": "entry.426303341",

            // III. Observational Checklist (E - Descent, Approach & Landing)
            // E11. Pre-landing preparation
            "E11_SOP": "entry.934967522",
            "E11_T": "entry.784966552",
            "E11_E": "entry.1863813369",
            "E11_U": "entry.728147575",
            "E11_C": "entry.1950060899",
            "E11_N_T": "entry.987769847",
            "E11_N_E": "entry.1764014301",
            "E11_N_U": "entry.624963579",
            "E11_N_C": "entry.1077141921",
            // E21. Seatbelts, tray tables, seatbacks, PEDs, etc.
            "E21_SOP": "entry.1415952792",
            "E21_T": "entry.465767298",
            "E21_E": "entry.1368694001",
            "E21_U": "entry.949799030",
            "E21_C": "entry.1421434713",
            "E21_N_T": "entry.46864606",
            "E21_N_E": "entry.1089123132",
            "E21_N_U": "entry.1268852935",
            "E21_N_C": "entry.9802823",
            // E22. Report cabin readiness (Landing)
            "E22_SOP": "entry.125942301",
            "E22_T": "entry.1801998281",
            "E22_E": "entry.1748850233",
            "E22_U": "entry.698899298",
            "E22_C": "entry.1145518338",
            "E22_N_T": "entry.94814236",
            "E22_N_E": "entry.751286212",
            "E22_N_U": "entry.1948997686",
            "E22_N_C": "entry.1375693615",
            // E23. Cabin lighting (Landing)
            "E23_SOP": "entry.319772383",
            "E23_T": "entry.971841036",
            "E23_E": "entry.939665475",
            "E23_U": "entry.1850344265",
            "E23_C": "entry.1581100619",
            "E23_N_T": "entry.1943957581",
            "E23_N_E": "entry.1686138790",
            "E23_N_U": "entry.1151177437",
            "E23_N_C": "entry.1969575195",
            // E24. Performing Brace position (Landing)
            "E24_SOP": "entry.247263658",
            "E24_T": "entry.302040797",
            "E24_E": "entry.489886889",
            "E24_U": "entry.2016810109",
            "E24_C": "entry.2064117713",
            "E24_N_T": "entry.671933511",
            "E24_N_E": "entry.892538647",
            "E24_N_U": "entry.2014682675",
            "E24_N_C": "entry.65506404",
            // E3. Sterile Flight Deck Adherence (Landing) (Note: This item does not follow the standard A##/B##/C## naming for SOP/Narrative, but I'll map them based on the provided list)
            "E3_SOP": "entry.1713395395", // Note: The old code uses E3_SOP, mapping to your provided entry
            "E3_T": "entry.714198069",
            "E3_E": "entry.161071890",
            "E3_U": "entry.1253058582",
            "E3_C": "entry.1916645682",
            "E3_N_T": "entry.2080595204",
            "E3_N_E": "entry.1642417991",
            "E3_N_U": "entry.1159846886",
            "E3_N_C": "entry.1489660250",
            // E41. Monitoring cabin condition (Landing)
            "E41_SOP": "entry.473239656",
            "E41_T": "entry.1023606954",
            "E41_E": "entry.1317574468",
            "E41_U": "entry.470720158",
            "E41_C": "entry.709062048",
            "E41_N_T": "entry.899668767",
            "E41_N_E": "entry.1832320871",
            "E41_N_U": "entry.714531196",
            "E41_N_C": "entry.518781836",

            // III. Observational Checklist (F - Taxi-In & Disembarkation)
            // F11. Arrival Announcement
            "F11_SOP": "entry.638590581",
            "F11_T": "entry.1164089855",
            "F11_E": "entry.189921590",
            "F11_U": "entry.853932126",
            "F11_C": "entry.436851987",
            "F11_N_T": "entry.1964766306",
            "F11_N_E": "entry.332016430",
            "F11_N_U": "entry.747667526",
            "F11_N_C": "entry.1076960977",
            // F12. Cabin monitoring (Arrival)
            "F12_SOP": "entry.1737134665",
            "F12_T": "entry.642606104",
            "F12_E": "entry.1800280403",
            "F12_U": "entry.2026366375",
            "F12_C": "entry.1868478413",
            "F12_N_T": "entry.1059615331",
            "F12_N_E": "entry.276319316",
            "F12_N_U": "entry.1965976339",
            "F12_N_C": "entry.1195353988",
            // F13. Doors Disarmed / Cross-check procedure
            "F13_SOP": "entry.435642301",
            "F13_T": "entry.158631466",
            "F13_E": "entry.2132715753",
            "F13_U": "entry.1151830669",
            "F13_C": "entry.2076717234",
            "F13_N_T": "entry.836606853",
            "F13_N_E": "entry.181433382",
            "F13_N_U": "entry.1791472122",
            "F13_N_C": "entry.1033806628",
            // F14. Doors Opening Procedure
            "F14_SOP": "entry.1437708124",
            "F14_T": "entry.2035891378",
            "F14_E": "entry.91554426",
            "F14_U": "entry.925680154",
            "F14_C": "entry.1279050193",
            "F14_N_T": "entry.1221574420",
            "F14_N_E": "entry.513319250",
            "F14_N_U": "entry.173353041",
            "F14_N_C": "entry.923490736",
            // F21. Cabin monitoring (Disembarkation)
            "F21_SOP": "entry.798596493",
            "F21_T": "entry.545244182",
            "F21_E": "entry.1821723410",
            "F21_U": "entry.255137900",
            "F21_C": "entry.1236528717",
            "F21_N_T": "entry.1722481717",
            "F21_N_E": "entry.337434974",
            "F21_N_U": "entry.755260668",
            "F21_N_C": "entry.286658893",
            // F22. Assistance to special categorized pax (Disembarkation)
            "F22_SOP": "entry.1933992730",
            "F22_T": "entry.1670860068",
            "F22_E": "entry.2066032670",
            "F22_U": "entry.775046917",
            "F22_C": "entry.589604722",
            "F22_N_T": "entry.2043093463",
            "F22_N_E": "entry.1021218808",
            "F22_N_U": "entry.1874672222",
            "F22_N_C": "entry.391599409",
            // F23. Refueling procedure (Disembarkation)
            "F23_SOP": "entry.1996586220",
            "F23_T": "entry.1101537494",
            "F23_E": "entry.1156499664",
            "F23_U": "entry.1533416376",
            "F23_C": "entry.1102500871",
            "F23_N_T": "entry.912249080",
            "F23_N_E": "entry.1820555558",
            "F23_N_U": "entry.1214152259",
            "F23_N_C": "entry.1800449422",
            // F24. Cabin check after passenger disembarkation and Report
            "F24_SOP": "entry.1102643854",
            "F24_T": "entry.1207808422",
            "F24_E": "entry.910011434",
            "F24_U": "entry.298547712",
            "F24_C": "entry.608088579",
            "F24_N_T": "entry.1172558499",
            "F24_N_E": "entry.928236203",
            "F24_N_U": "entry.1280366915",
            "F24_N_C": "entry.1995727079",
            // F31. Perform Security Checks (Post-Flight)
            "F31_SOP": "entry.1711336952",
            "F31_T": "entry.516635649",
            "F31_E": "entry.1593306999",
            "F31_U": "entry.291092027",
            "F31_C": "entry.1841471876",
            "F31_N_T": "entry.109228140",
            "F31_N_E": "entry.870707135",
            "F31_N_U": "entry.899388459",
            "F31_N_C": "entry.1101223052",
            // F32. Perform transit duties
            "F32_SOP": "entry.2050675303",
            "F32_T": "entry.1796770779",
            "F32_E": "entry.574065456",
            "F32_U": "entry.699827971",
            "F32_C": "entry.1815940301",
            "F32_N_T": "entry.1897961628",
            "F32_N_E": "entry.1021025015",
            "F32_N_U": "entry.1935927592",
            "F32_N_C": "entry.1990692888",
            // F33. Reporting cabin defects (If any)
            "F33_SOP": "entry.606660181",
            "F33_T": "entry.1634724952",
            "F33_E": "entry.785754025",
            "F33_U": "entry.480123045",
            "F33_C": "entry.2107165555",
            "F33_N_T": "entry.2124035557",
            "F33_N_E": "entry.1510740073",
            "F33_N_U": "entry.1052892765",
            "F33_N_C": "entry.655682078",

            // III. Observational Checklist (G - Post-Flight / Debrief)
            // G11. Discussion of flight events
            "G11_SOP": "entry.940946827",
            "G11_T": "entry.1100653761",
            "G11_E": "entry.669859803",
            "G11_U": "entry.1435636330",
            "G11_C": "entry.1548127200",
            "G11_N_T": "entry.838667762",
            "G11_N_E": "entry.1088935568",
            "G11_N_U": "entry.591709759",
            "G11_N_C": "entry.1172850702",
            // G12. Sharing idea
            "G12_SOP": "entry.2052533144",
            "G12_T": "entry.1723480899",
            "G12_E": "entry.569720207",
            "G12_U": "entry.2092907890",
            "G12_C": "entry.816506723",
            "G12_N_T": "entry.1413449774",
            "G12_N_E": "entry.1014438224",
            "G12_N_U": "entry.793919990",
            "G12_N_C": "entry.844890121",
            // G13. Feedback on TEM
            "G13_SOP": "entry.1624675734",
            "G13_T": "entry.1622802075",
            "G13_E": "entry.1262756149",
            "G13_U": "entry.2042209244",
            "G13_C": "entry.1626389597",
            "G13_N_T": "entry.174414491",
            "G13_N_E": "entry.1428223858",
            "G13_N_U": "entry.1916893435",
            "G13_N_C": "entry.1152903322",
            // G21. Redeye Report
            "G21_SOP": "entry.908683297",
            "G21_T": "entry.674660696",
            "G21_E": "entry.1919943708",
            "G21_U": "entry.256637151",
            "G21_C": "entry.59802565",
            "G21_N_T": "entry.1173379928",
            "G21_N_E": "entry.1538121285",
            "G21_N_U": "entry.370790187",
            "G21_N_C": "entry.2138559636",

            // IV. Overall Observations & Summary
            "sigThreat": "entry.740427907",
            "sigError": "entry.1575542333",
            "effectiveCm": "entry.811828017",
            "generalComments": "entry.802020804",
            "areasOfStrength": "entry.328493832",
            "opportunitiesForImprovement": "entry.266734822",
            "observerSignature": "entry.1749358988",
            "reportCompletionDate": "entry.21437297"
        };

        // *** II. TEM FRAMEWORK KEY (รหัส) ***
        const TEM_CODES = {
            THREATS: {
                T_TE: "TE: Environmental (Weather, Turbulence, Airport Conditions, Time of Day)",
                T_TO: "TO: Operational (Delays, Aircraft Changes/MEL, ATC, Ground Handling, Catering)",
                T_TC: "TC: Cabin/Passenger (Unruly Pax, Medical, Equipment Malfunction)",
                T_TT: "TT: Team/Crew (Fatigue, Conflict, Inexperience, Communication Breakdown)",
                T_TL: "TL: Latent (Flawed Procedures, Inadequate Training, Poor Equipment Design)"
            },
            ERRORS: {
                E_EP: "EP: Procedural (Non-compliance with SOPs, Checklist errors, Incorrect use of equipment)",
                E_EC: "EC: Communication (Misunderstood instructions, Poor handover, Lack of assertiveness)",
                E_ED: "ED: Decision (Flawed risk assessment, Poor judgment, Incorrect problem-solving)",
                E_ES: "ES: Skill-based/Proficiency (Slip, Lapse, Incorrect execution of a learned skill)",
                E_EV: "EV: Violation (Intentional Non-Compliance)"
            },
            UCS: {
                U_SOP: "UCS-SOP: Deviation from SOP", U_EQP: "UCS-EQP: Incorrect Equipment use", U_PAX: "UCS-PAX: Compromised PAX safety", U_COM: "UCS-COM: Degraded Communication"
            },
            CM: {
                C_PLN: "CM-PLN: Planning (Briefings, 'what-if' scenarios)",
                C_SOP: "CM-SOP: Procedural (Following checklists, SOPs)",
                C_COM: "CM-COM: Communication (Clear communication, Cross-checking, Assertiveness)",
                C_MON: "CM-MON: Monitoring (Vigilance, Scanning, Cross-checking)",
                C_WSM: "CM-WSM: Workload/Systems Management (Prioritization, Delegation)",
                C_SPT: "CM-SPT: Support/Teamwork (Seeking assistance, Providing support, Crew coordination)"
            }
        };

        const TEM_OPTIONS_MAP = {
            'Threats': TEM_CODES.THREATS,
            'Errors': TEM_CODES.ERRORS,
            'UCS': TEM_CODES.UCS,
            'Countermeasures': TEM_CODES.CM
        };

        // *** III. OBSERVATIONAL CHECKLIST DEFINITION (โครงสร้าง) ***
        const CHECKLIST_DEFINITIONS = [
            { id: 'A', title: 'A. Pre-Flight & Crew Briefing', items: [
                { id: 'A1', label: '1. Crew Briefing (All Crew - Flight & Cabin)', isGroup: true, subItems: [
                    { id: 'A11', label: '- Attendance/ Punctuality/ Grooming' },
                    { id: 'A12', label: '- Documentation (Flight document)' },
                    { id: 'A13', label: '- Review updated safety information' },
                    { id: 'A14', label: '- Safety/First aid/Security/DG Review' },
                    { id: 'A15', label: '- Service Review (if applicable)' },
                    { id: 'A16', label: '- TEM discussion (anticipated threats)' },
                    { id: 'A17', label: '- Crew Co-ordination & Communication established' }
                ]},
                { id: 'A2', label: '2. Cabin Crew Briefing (Cabin Specific)', isGroup: true, subItems: [
                    { id: 'A21', label: '- Allocation of CC station' },
                    { id: 'A22', label: '- A/C type and equipment fitted' },
                    { id: 'A23', label: '- Emergency Procedures Review' },
                    { id: 'A24', label: '- Security Procedures Review (e.g., checked, search, risk level)' },
                    { id: 'A25', label: '- Special Categoried Passenger Info (e.g., PRMs, YPTA)' }
                ]},
                { id: 'A3', label: '3. Pre-Flight Cabin Checks', isGroup: true, subItems: [
                    { id: 'A31', label: '- Doors (pre-flight check, serviceablility)' },
                    { id: 'A32', label: '- Emergency Equipment (location, serviceability)' },
                    { id: 'A33', label: '- Security Checks (cabin, lavatories, galleys, attendant station)' },
                    { id: 'A34', label: '- Cabin Cleanliness & Appearance' },
                    { id: 'A35', label: '- Catering/Supplies (if applicable)' },
                    { id: 'A36', label: '- Interphone/PA System Check' }
                ]}
            ]},
            { id: 'B', title: 'B. Boarding', items: [
                { id: 'B1', label: '1. Passenger Greeting & Assistance', isGroup: true, subItems: [
                    { id: 'B11', label: '- Monitoring carry-on baggage (size, quantity)' },
                    { id: 'B12', label: '- Refuelling procedure' },
                    { id: 'B13', label: '- Exit row briefing & compliance' },
                    { id: 'B14', label: '- Assistance and briefing to special categoried passengers (e.g., PRMs)' },
                    { id: 'B15', label: '- Managing passenger flow' }
                ]},
                { id: 'B2', label: '2. Pre-Departure Cabin Secure', isGroup: true, subItems: [
                    { id: 'B21', label: '- Overhead bins closed' },
                    { id: 'B22', label: '- Galley equipment secured' },
                    { id: 'B23', label: '- Doors/Aisles/Exits clear' },
                    { id: 'B24', label: '- Passenger count reconciliation' },
                    { id: 'B25', label: '- Doors armed / Cross-check procedure' },
                    { id: 'B26', label: '- Welcome Announcement' }
                ]},
                { id: 'B3', label: '3. Safety Demonstration', isGroup: true, subItems: [
                    { id: 'B31', label: '- Clarity, accuracy, visibility' },
                    { id: 'B32', label: '- Passenger attentiveness (managed if needed)' }
                ]}
            ]},
            { id: 'C', title: 'C. Taxi-Out, Take-off & Climb', items: [
                { id: 'C1', label: '1. Final Cabin Checks', isGroup: true, subItems: [
                    { id: 'C11', label: '- Take off preparation' },
                    { id: 'C12', label: '- Report cabin readiness' },
                    { id: 'C13', label: '- Cabin lighting' },
                    { id: 'C14', label: '- Performing Brace position' }
                ]},
                { id: 'C2', label: '2. Response to Take-off/Climb', isGroup: true, subItems: [
                    { id: 'C21', label: '- Sterile Flight Deck Adherence' },
                    { id: 'C22', label: '- Monitoring cabin condition' },
                    { id: 'C23', label: '- Awareness of adhoc situation' }
                ]}
            ]},
            { id: 'D', title: 'D. Cruise', items: [
                { id: 'D1', label: '1. Service Delivery (if applicable)', isGroup: true, subItems: [
                    { id: 'D11', label: '- Efficiency, safety during service' },
                    { id: 'D12', label: '- Galley management' }
                ]},
                { id: 'D2', label: '2. Cabin Surveillance', isGroup: true, subItems: [
                    { id: 'D21', label: '- Periodically check cabin' },
                    { id: 'D22', label: '- Periodically check on flght crew' },
                    { id: 'D23', label: '- Periodically check Lavatory' },
                    { id: 'D24', label: '- Response to call light and Reset' }
                ]},
                { id: 'D3', label: '3. Passenger Handling (if any)', isGroup: true, subItems: [
                    { id: 'D31', label: '- Medical situations' },
                    { id: 'D32', label: '- Unruly/disruptive passengers' },
                    { id: 'D33', label: '- Others' }
                ]}
                ,
                { id: 'D4', label: '4. Communication with Flight Crew (if any)', isGroup: true, subItems: [
                    { id: 'D41', label: '- Reporting irregularities (If any)' }
                ]}
                ,
                { id: 'D5', label: '5. Turbulence Management', isGroup: true, subItems: [
                    { id: 'D51', label: '- Follow turbulance management procedure' },
                    { id: 'D52', label: '- Secure self' }
                ]}
            ]},
            { id: 'E', title: 'E. Descent, Approach & Landing', items: [
                { id: 'E1', label: '1. Pre-Landing Announcements & Cabin Prep', isGroup: true, subItems: [
                    { id: 'E11', label: '- Pre-landing preparation' }
                ]},
                { id: 'E2', label: '2. Final Cabin Checks (Landing)', isGroup: true, subItems: [
                    { id: 'E21', label: '- Seatbelts, tray tables, seatbacks, PEDs, etc.' },
                    { id: 'E22', label: '- Report cabin readiness' },
                    { id: 'E23', label: '- Cabin lighting' },
                    { id: 'E24', label: '- Performing Brace position' }
                ]},
                { id: 'E3', label: '3. Sterile Flight Deck Adherence' },
                { id: 'E4', label: '4. Response to Landing', isGroup: true, subItems: [
                    { id: 'E41', label: '- Monitoring cabin condition' }
                ]}
            ]},
            { id: 'F', title: 'F. Taxi-In & Disembarkation', items: [
                { id: 'F1', label: '1. Arrival Duties', isGroup: true, subItems: [
                    { id: 'F11', label: '- Arrival Announcement' },
                    { id: 'F12', label: '- Cabin monitoring' },
                    { id: 'F13', label: '- Doors Disarmed / Cross-check procedure' },
                    { id: 'F14', label: '- Doors Opening Procedure' }
                ]},
                { id: 'F2', label: '2. Disembarkation Process', isGroup: true, subItems: [
                    { id: 'F21', label: '- Cabin monitoring' },
                    { id: 'F22', label: '- Assistance to special categoried passenger' },
                    { id: 'F23', label: '- Refueling procedure (If any)' },
                    { id: 'F24', label: '- Cabin check after passenger disembarkation and Report' }
                ]},
                { id: 'F3', label: '3. Post-Flight Cabin Checks', isGroup: true, subItems: [
                    { id: 'F31', label: '- Perform Security Checks' },
                    { id: 'F32', label: '- Perform transit duties' },
                    { id: 'F33', label: '- Reporting cabin defects (If any)' }
                ]}
            ]},
            { id: 'G', title: 'G. Post-Flight / Debrief (Observed if possible)', items: [
                { id: 'G1', label: '1. Crew Debrief', isGroup: true, subItems: [
                    { id: 'G11', label: '- Discussion of flight events' },
                    { id: 'G12', label: '- Sharing idea' },
                    { id: 'G13', label: '- Feedback on TEM' }
                ]},
                { id: 'G2', label: '2. Reporting System', isGroup: true, subItems: [
                    { id: 'G21', label: '- Redeye' }
                ]}
            ]}
        ];

        const form = document.getElementById('checklist-form');
        const checklistContainer = document.getElementById('checklist-container');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const pendingCount = document.getElementById('pending-count');
        const pendingList = document.getElementById('pending-list');
        const manualSyncBtn = document.getElementById('manual-sync-btn');
        let hasShownSyncPrompt = false;

        // *** HELPER FUNCTIONS ***
        function showToast(message, icon = 'success') {
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, });
            Toast.fire({ icon: icon, title: message });
        }

        // --- NEW FUNCTION: createCheckboxGroup (สร้าง Checkbox สำหรับ TEM Codes) ---
        function createCheckboxGroup(baseName, typeCode, options) {
            let html = `<div class="checkbox-container">`;
            
            for (const code in options) {
                if (options.hasOwnProperty(code)) {
                    const fieldName = `${baseName}_${typeCode}`;
                    const inputValue = options[code]; // ค่าเต็มที่ส่งไป Google Form
                    
                    // ดึงเฉพาะโค้ดสั้น (เช่น TE, EP, PLN)
                    const shortCode = code.split('_')[1] || code;

                    html += `
                        <label title="${options[code]}" class="inline-flex items-center space-x-1 cursor-pointer">
                            <input type="checkbox" name="${fieldName}" value="${inputValue}" class="form-checkbox text-red-600 rounded">
                            <span>${shortCode}</span>
                        </label>
                    `;
                }
            }
            html += `</div>`;
            return html;
        }

        // --- REVISED: createDropdown (ใช้สำหรับ SOP Y/N/NA เท่านั้น) ---
        function createDropdown(name, isSOP = false) {
            const select = document.createElement('select');
            select.name = name;
            select.className = `w-full border rounded-lg bg-white sop-dropdown`;
            select.required = isSOP;

            if (isSOP) {
                select.innerHTML = '';
                select.innerHTML += `<option value="" disabled selected>-- Select --</option>`;
                ['Y', 'N', 'NA'].forEach(v => {
                    select.innerHTML += `<option value="${v}">${v}</option>`;
                });
            }

            return select.outerHTML;
        }

        function createTextArea(name, placeholder) {
            return `<textarea name="${name}" rows="1" class="w-full border rounded-lg narrative-textarea" placeholder="${placeholder}"></textarea>`;
        }

        function generateChecklistHTML() {
            let html = '';
            CHECKLIST_DEFINITIONS.forEach(section => {
                html += `<div class="mb-8">`;
                html += `<h3 class="text-md font-bold text-white bg-red-600 p-2 rounded-t-lg">${section.title}</h3>`;
                html += `<div class="overflow-x-auto"><table class="checklist-table w-full">`;
                 html += `<thead><tr>`;
                html += `<th class="item-col">Check Item / Area of Observation</th>`;
                html += `<th class="sop-col required-asterisk">SOP Met (Y/N/NA)</th>`;
                html += `<th class="code-col bg-t">Threats (Code)</th>`;
                html += `<th class="code-col bg-e">Errors (Code)</th>`;
                html += `<th class="code-col bg-u">UCS (Code)</th>`;
                html += `<th class="code-col bg-c">CM (Code)</th>`;
                html += `<th class="narrative-col">Narrative/Comments</th>`; // Single Narrative column
                html += `</tr></thead><tbody>`;

                section.items.forEach(item => {
                    const itemsToRender = item.isGroup && item.subItems ? item.subItems : [item];

                    if (item.isGroup && item.subItems) {
                        html += `<tr class="checklist-item-group"><td colspan="7" class="text-sm font-semibold">${item.label}</td></tr>`;
                    }

                    itemsToRender.forEach(subItem => {
                        const baseName = `${subItem.id}`;

                        // SOP Dropdown (ยังคงใช้ Dropdown)
                        const sopDropdown = createDropdown(`${baseName}_SOP`, true);

                        // TEM Checkbox Groups (ใช้ CheckboxGroup แทน Dropdown)
                        const tCheckbox = createCheckboxGroup(baseName, 'T', TEM_OPTIONS_MAP.Threats);
                        const eCheckbox = createCheckboxGroup(baseName, 'E', TEM_OPTIONS_MAP.Errors);
                        const ucsCheckbox = createCheckboxGroup(baseName, 'U', TEM_OPTIONS_MAP.UCS);
                        const cmCheckbox = createCheckboxGroup(baseName, 'C', TEM_OPTIONS_MAP.Countermeasures);

                        // Single Narrative/Comment (MAPPED to the first narrative field: N_T)
                        const mainNarrative = createTextArea(`${baseName}_N_T`, 'Narrative/Describe here...');

                        html += `<tr class="checklist-item text-xs">`;
                        html += `<td class="font-normal">${subItem.label}</td>`;
                        html += `<td>${sopDropdown}</td>`;
                        // ใช้ Checkbox ที่สร้างใหม่
                        html += `<td class="bg-t">${tCheckbox}</td>`;
                        html += `<td class="bg-e">${eCheckbox}</td>`;
                        html += `<td class="bg-u">${ucsCheckbox}</td>`;
                        html += `<td class="bg-c">${cmCheckbox}</td>`;
                        
                        html += `<td class="bg-t">${mainNarrative}</td>`; // Use the main narrative field
                        html += `</tr>`;
                    });
                });
                html += `</tbody></table></div></div>`;
            });

            checklistContainer.innerHTML = html;
        }

        // PWA/Offline Functions (Unchanged)
        function showSyncConfirmation() {
            const submissions = JSON.parse(localStorage.getItem('pendingSubmissions') || '[]');
            if (submissions.length === 0 || !navigator.onLine || hasShownSyncPrompt) {
                return;
            }
            hasShownSyncPrompt = true;

            Swal.fire({
                title: 'Connection Detected', text: `You have ${submissions.length} item(s) waiting. Sync now?`, icon: 'info',
                showCancelButton: true, confirmButtonColor: '#28a745', cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, sync now!', cancelButtonText: 'Later'
            }).then((result) => {
                if (result.isConfirmed) {
                    syncData();
                }
            });
        }
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            statusText.textContent = isOnline ? 'Online' : 'Offline';
            statusDot.className = `status-dot ${isOnline ? 'online' : 'offline'}`;
            if (isOnline) {
                showSyncConfirmation();
            } else {
                hasShownSyncPrompt = false;
            }
            updatePendingUI();
        }
        function saveDataLocally(data) {
            const submissions = JSON.parse(localStorage.getItem('pendingSubmissions') || '[]');
            submissions.push(data);
            localStorage.setItem('pendingSubmissions', JSON.stringify(submissions));
            updatePendingUI();
            Swal.fire({ title: 'Checklist Saved!', text: 'Data saved locally. Will sync when online.', icon: 'success', confirmButtonColor: '#DC2626', confirmButtonText: 'OK' });
        }
        function updatePendingUI() {
            const submissions = JSON.parse(localStorage.getItem('pendingSubmissions') || '[]');
            pendingCount.textContent = submissions.length;
            pendingList.innerHTML = submissions.length === 0 ? '<p class="text-gray-500 text-center">No pending items.</p>' : submissions.map((sub) =>
                `<div class="flex justify-between items-center p-2 border-b">
                    <div>
                        <strong class="text-sm">${sub.inspectorName} - FD${sub.flightNumberNew || sub.flightNumber || 'N/A'}</strong>
                        <span class="text-xs text-gray-500 block">${new Date(sub.timestamp).toLocaleString()}</span>
                    </div>
                    <button data-timestamp="${sub.timestamp}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">
                        ลบ
                    </button>
                </div>`
            ).join('');
            const isOnline = navigator.onLine;
            manualSyncBtn.classList.toggle('hidden', !isOnline || submissions.length === 0);
        }
        function deletePendingItem(timestamp) {
             Swal.fire({
                title: 'Confirm Deletion', text: "Are you sure you want to delete this record?", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!', cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    let submissions = JSON.parse(localStorage.getItem('pendingSubmissions') || '[]');
                    submissions = submissions.filter(sub => sub.timestamp !== timestamp);
                    localStorage.setItem('pendingSubmissions', JSON.stringify(submissions));
                    updatePendingUI();
                    showToast('Record deleted', 'success');
                }
            })
        }
        
        // *** แก้ไข: ปรับ syncData ให้ส่งค่า Checkbox เป็น String เดียว ***
        async function syncData() {
            if (!navigator.onLine) return;
            let submissions = JSON.parse(localStorage.getItem('pendingSubmissions') || '[]');
            if (submissions.length === 0) return;

            showToast(`Syncing ${submissions.length} item(s)...`, 'info');
            const successfullySynced = [];

            for (const submission of submissions) {
                const formData = new FormData();

                for (const key in submission) {
                    const entryId = INPUT_MAPPING[key];
                    const value = submission[key];
                    
                    if (entryId) {
                        // ส่งค่าทั้งหมดเป็น String เดียว (รวมถึงค่าที่เคยเป็น Array จาก Checkbox)
                        // ไม่ต้องใช้ Array.isArray เนื่องจากถูกแปลงเป็น String แล้วใน submit handler
                        if (value !== null && value !== "") { 
                            formData.append(entryId, value);
                        }
                    }
                }

                try {
                    // ใช้ fetch API ในการส่งข้อมูล
                    await fetch(GOOGLE_FORM_ACTION_URL, {
                        method: 'POST', body: formData, mode: 'no-cors'
                    });
                    successfullySynced.push(submission);
                } catch (error) {
                    console.error('Sync Error:', error);
                    showToast('Sync failed. Please check connection and try again.', 'error');
                    break;
                }
            }

            if (successfullySynced.length > 0) {
                const newSubmissions = submissions.filter(sub => !successfullySynced.find(s => s.timestamp === sub.timestamp));
                localStorage.setItem('pendingSubmissions', JSON.stringify(newSubmissions));
                updatePendingUI();
                showToast(`Successfully synced ${successfullySynced.length} item(s)!`, 'success');
            }
        }

        // *** แก้ไข: ปรับ form.addEventListener เพื่อแปลง Checkbox เป็น String ***
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = { timestamp: new Date().toISOString() };

            // I. Flight & Audit Details & IV. Summary
            data['observationDate'] = formData.get('observation-date');
            data['flightNumberNew'] = formData.get('flight-number-new');
            data['routeFrom'] = formData.get('route-from');
            data['routeTo'] = formData.get('route-to');
            data['aircraftType'] = formData.get('aircraft-type');
            data['observerId'] = formData.get('observer-id');
            data['crewObserved'] = formData.get('crew-observed');
            data['loadFactor'] = formData.get('load-factor');
            data['inspectorName'] = formData.get('inspector-name');
            data['flightNumber'] = formData.get('flight-number-new');

            data['sigThreat'] = formData.get('sig-threat') || "";
            data['sigError'] = formData.get('sig-error') || "";
            data['effectiveCm'] = formData.get('effective-cm') || "";
            data['generalComments'] = formData.get('general-comments') || "";
            data['areasOfStrength'] = formData.get('areas-of-strength') || "";
            data['opportunitiesForImprovement'] = formData.get('opportunities-for-improvement') || "";
            data['observerSignature'] = formData.get('observer-signature') || "";
            data['reportCompletionDate'] = formData.get('report-completion-date');

            // III. Observational Checklist (รวบรวม Checkbox และ Narrative)
            const allInputs = form.querySelectorAll('select, textarea, input[type="text"], input[type="number"], input[type="date"], input[type="checkbox"]');
            
            // Object เพื่อเก็บค่า Checkbox (TEM Codes)
            const temData = {}; 
            const singleData = {}; 

            allInputs.forEach(input => {
                const name = input.name;
                const value = input.value || "";

                if (input.type === 'checkbox') {
                    if (input.checked) {
                        if (!temData[name]) {
                            temData[name] = [];
                        }
                        // เก็บค่าเต็ม (full description)
                        temData[name].push(value); 
                    }
                } 
                else {
                    singleData[name] = value;
                }
            });

            // 1. จัดการ Checkbox: แปลง Array ของ TEM Codes เป็นข้อความที่คั่นด้วยตัวแบ่ง (String)
            for (const name in temData) {
                // ใช้ join(' | ') เพื่อรวม Array เป็น String เดียวสำหรับส่งเข้าช่อง Text ของ Google Form
                data[name] = temData[name].join(' | '); 
            }

            // 2. จัดการ SOP และ Narrative Fields
            for (const name in singleData) {
                const value = singleData[name];
                
                // Collect SOP values (single dropdown)
                if (name.match(/^[A-G][0-9][0-9]_SOP$/) || name.match(/^E3_SOP$/)) {
                    data[name] = value;
                } 
                // จัดการ Narrative Fields: คัดลอกค่าเดียวไปยัง 4 ช่อง (N_T, N_E, N_U, N_C)
                else if (name.match(/_N_T$/) || name.match(/^E3_N_T$/)) {
                    const base = name.replace('_N_T', '');
                    data[`${base}_N_T`] = value; 
                    data[`${base}_N_E`] = value; 
                    data[`${base}_N_U`] = value; 
                    data[`${base}_N_C`] = value; 
                }
                // เก็บค่าอื่นๆ (Details, Summary)
                else if (!data.hasOwnProperty(name)) { 
                     data[name] = value;
                }
            }
            
            saveDataLocally(data);
            form.reset();
        });

        document.addEventListener('DOMContentLoaded', () => {
            generateChecklistHTML(); // สร้างตาราง checklist
            updateOnlineStatus();
            updatePendingUI();

            pendingList.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    deletePendingItem(e.target.dataset.timestamp);
                }
            });

            manualSyncBtn.addEventListener('click', syncData);

            if ('serviceWorker' in navigator) {
                // Check if the page is loaded from a blob URL (common in preview environments)
                if (window.location.protocol === 'blob:') {
                    console.warn("Service Worker registration skipped: Cannot register from a 'blob:' URL. This is expected in preview environments and will work correctly on the deployed site.");
                } else {
                    // PWA Service Worker code (If you have sw.js)
                    // navigator.serviceWorker.register('sw.js')
                    //     .then(reg => console.log('Service Worker registered successfully'))
                    //     .catch(err => console.error('Service worker registration failed:', err));
                }
            }
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        });
    </script>
</body>
</html>

